(function(a){if(typeof define==="function"&&define.amd){define(["leaflet"],function(b){return a(b)})}else{if(typeof module==="object"&&typeof module.exports==="object"){module.exports=a(require("leaflet"))}}if(typeof window!=="undefined"&&window.L){a(window.L)}}(function(a){a.Config={};a.Map=a.Map.extend({options:{crs:a.CRS.EPSG4326,attributionControl:false,minZoom:2},getScales:function(){return[591658710.9091312,295829355.4545656,147914677.7272828,73957338.8636414,36978669.4318207,18489334.71591035,9244667.357955175,4622333.678977588,2311166.839488794,1155583.419744397,577791.7098721985,288895.85493609926,144447.92746804963,72223.96373402482,36111.98186701241,18055.990933506204,9027.995466753102,4513.997733376551,2256.998866688275,1128.4994333441375,564.2497166720685]}});a.GEvent={listeners:[],addListener:function(b,c){this.removeListener(b,c);this.listeners.push({name:b,closure:c})},removeListener:function(b,f){var e;var c=0;var d=this.listeners.length;if(f){for(;c<d;c++){e=this.listeners[c];if(e.name===b&&e.closure===f){this.listeners.splice(c,1);c--;d--}}}else{this.removeListenerFor(b)}},dispatch:function(b,e){var f;var c=0;var d=this.listeners.length;for(;c<d;c++){f=this.listeners[c];if(!f){continue}if(f.name===b){f.closure.call(this,e)}}},hasListenerFor:function(b){var e;var c=0;var d=this.listeners.length;for(;c<d;c++){if(this.listeners[c].name===b){return true}}return false},hasListeners:function(){return this.listeners.length>0},removeAllListeners:function(){this.listeners=[]},removeListenerFor:function(b){var e;var c=0;var d=this.listeners.length;for(;c<d;c++){e=this.listeners[c];if(e.name===b){this.listeners.splice(c,1);c--;d--}}},on:function(b,c){this.addListener(b,c)},off:function(b,d){var c=arguments.length;if(c==0){this.removeAllListeners()}else{if(c==1){this.removeListenerFor(arguments[0])}else{if(c>=2){this.removeListener(arguments[0],arguments[1])}}}},trigger:function(b,c){this.dispatch(b,c)}};a.FeatureManager=a.Class.extend({options:{map:null,featureGroup:null,classifyList:null,},initialize:function(b){this.options=a.setOptions(this,b);this.options.classifyList={};this.options.featureGroup=b.featureGroup||a.featureGroup();this.options.map.addLayer(this.options.featureGroup);this._initEvents()},_initEvents:function(){var b=this.options.map;this.options.featureGroup.on("click",function(c){this.resetFeatureIcon();if(c.layer.onFeatureClick){c.layer.onFeatureClick(c.layer)}c.layer.setIcon(c.layer.options.hightIcon)},this);this.options.featureGroup.on("mouseover",function(c){c.layer.setIcon(c.layer.options.hightIcon);if(c.layer.onFeatureOver){c.layer.onFeatureOver(c.layer)}});this.options.featureGroup.on("mouseout",function(f){var c=f.layer.getPopup();var d=b._popup;if(!(c&&d&&(c==d))){f.layer.setIcon(f.layer.options.unhightIcon)}if(f.layer.onFeatureOut){f.layer.onFeatureOut(f.layer)}});this.options.featureGroup.on("popupclose",function(c){c.layer.setIcon(c.layer.options.unhightIcon)},this)},createFeatureSort:function(e,c){var c=c||{};var f=c.onFeatureClick;var b=c.onFeatureOver;var d=c.onFeatureOut;var g={features:[],onFeatureClick:f,onFeatureOver:b,onFeatureOut:d};this.options.classifyList[e]=g},addFeatures:function(d,c,e){if(!c||typeof(c)!="string"){return}if(!(d instanceof Array)){d=[d]}var b=this.options.classifyList;if(b[c]){var d=this._processFeatures(d,c);if(!e){b[c].features=d}else{b[c].features=b[c].features.concat(d)}}},_processFeatures:function(f,e){var b=this.options.classifyList[e];for(var d=0;d<f.length;d++){var c=f[d];c.sort=e;c.onFeatureClick=b.onFeatureClick;c.onFeatureOver=b.onFeatureOver;c.onFeatureOut=b.onFeatureOut}return f},drawFeaturesToMap:function(e){var d;if(typeof(e)=="string"){var c=e||"default";if(this.options.classifyList[c]){d=this.getFeatures(c)}}if(e instanceof Array){d=e}if(!d){return false}for(var b=0;b<d.length;b++){d[b].setIcon(d[b].options.unhightIcon);this.options.featureGroup.addLayer(d[b])}},clearFeaturesFromMap:function(d){if(!d||typeof(d)!="string"){return}var e;var b=this.options.classifyList[d];if(d=="allType"){e=this.options.featureGroup.getLayers()}else{e=b?b.features:[]}if(e){for(var c=0;c<e.length;c++){this.options.featureGroup.removeLayer(e[c])}this.options.classifyList[d].features=[]}},getFeatures:function(b){if(!b||typeof(b)!="string"){return}if(this.options.classifyList[b]){return this.options.classifyList[b].features}else{return}},resetFeatureIcon:function(){this.options.featureGroup.eachLayer(function(b){b.setIcon(b.options.unhightIcon)})}});a.featureManager=function(b){return new a.FeatureManager(b)};a.TipPopup=a.Popup.extend({includes:a.Mixin.Events,initialize:function(b,c){this._sort="tip-popup";a.Popup.prototype.initialize.call(this,b,c)},_getEvents:function(){var b={viewreset:this._updatePosition};if(this._animated){b.zoomanim=this._zoomAnimation}if(this.options.keepInView){b.moveend=this._adjustPan}return b},openOn:function(b){b.openTipPopup(this)},_initLayout:function(){var c="leaflet-popup",d=c+" "+this.options.className+" leaflet-zoom-"+(this._animated?"animated":"hide"),b=this._container=a.DomUtil.create("div",d);var e=this._wrapper=a.DomUtil.create("div",c+"-content-wrapper measure-tip-wrapper",b);a.DomEvent.disableClickPropagation(e);this._contentNode=a.DomUtil.create("div",c+"-tipcontent",e);a.DomEvent.disableScrollPropagation(this._contentNode);a.DomEvent.on(e,"contextmenu",a.DomEvent.stopPropagation)}});a.Map.include({openTipPopup:function(b,e,c){if(!(b instanceof a.Popup)){var d=b;b=new a.TipPopup(c).setLatLng(e).setContent(d)}b._isOpen=true;this._popup=b;return this.addLayer(b)},closePopup:function(b){if(!b||b===this._popup){b=this._popup;this._popup=null}if(b&&b._sort!="tip-popup"){this.removeLayer(b);b._isOpen=false}return this}});a.LatLngUtil={cloneLatLngs:function(b){var e=[];for(var d=0,c=b.length;d<c;d++){e.push(this.cloneLatLng(b[d]))}return e},cloneLatLng:function(b){return a.latLng(b.lat,b.lng)}};a.ProxyUtil=function(f,e){var b,d,c;if(typeof e==="string"){c=f[e];e=f;f=c}if(!(typeof f=="function")){return undefined}b=Array.prototype.slice.call(arguments,2);d=function(){return f.apply(e||this,b.concat(Array.prototype.slice.call(arguments)))};return d};a.GeometryUtil=a.extend(a.GeometryUtil||{},{geodesicArea:function(g){var d=g.length,e=0,b=a.LatLng.DEG_TO_RAD,h,f;if(d>2){for(var c=0;c<d;c++){h=g[c];f=g[(c+1)%d];e+=((f.lng-h.lng)*b)*(2+Math.sin(h.lat*b)+Math.sin(f.lat*b))}e=e*6378137*6378137/2}return Math.abs(e)},readableArea:function(c,b){var d;if(b){if(c>=1000000){d=(c*0.000001).toFixed(2)+" 平方公里"}else{d=c.toFixed(2)+" 平方米;"}}else{c/=0.836127;if(c>=3097600){d=(c/3097600).toFixed(2)+" mi&sup2;"}else{if(c>=4840){d=(c/4840).toFixed(2)+" acres"}else{d=Math.ceil(c)+" yd&sup2;"}}}return d},readableDistance:function(f,b,d){var e;if(b){if(f>1000){e=(f/1000).toFixed(2)+" 千米"}else{e=Math.ceil(f)+" 米"}}else{f*=1.09361;if(f>1760){e=(f/1760).toFixed(2)+" miles"}else{var c=" yd";if(d){f=f*3;c=" ft"}e=Math.ceil(f)+c}}return e}});a.Util.extend(a.LineUtil,{segmentsIntersect:function(d,e,c,b){return this._checkCounterclockwise(d,c,b)!==this._checkCounterclockwise(e,c,b)&&this._checkCounterclockwise(d,e,c)!==this._checkCounterclockwise(d,e,b)},_checkCounterclockwise:function(c,d,b){return(b.y-c.y)*(d.x-c.x)>(d.y-c.y)*(b.x-c.x)}});a.Polyline.include({intersects:function(){var d=this._originalPoints,b=d?d.length:0,c,e,f;if(this._tooFewPointsForIntersection()){return false}for(c=b-1;c>=3;c--){e=d[c-1];f=d[c];if(this._lineSegmentsIntersectsRange(e,f,c-2)){return true}}return false},newLatLngIntersects:function(c,b){if(!this._map){return false}return this.newPointIntersects(this._map.latLngToLayerPoint(c),b)},newPointIntersects:function(c,f){var e=this._originalPoints,b=e?e.length:0,g=e?e[b-1]:null,d=b-2;if(this._tooFewPointsForIntersection(1)){return false}return this._lineSegmentsIntersectsRange(g,c,d,f?1:0)},_tooFewPointsForIntersection:function(d){var c=this._originalPoints,b=c?c.length:0;b+=d||0;return !this._originalPoints||b<=3},_lineSegmentsIntersectsRange:function(h,i,d,c){var e=this._originalPoints,g,f;c=c||0;for(var b=d;b>c;b--){g=e[b-1];f=e[b];if(a.LineUtil.segmentsIntersect(h,i,g,f)){return true}}return false}});a.Polygon.include({intersects:function(){var f,d=this._originalPoints,b,g,e,c;if(this._tooFewPointsForIntersection()){return false}f=a.Polyline.prototype.intersects.call(this);if(f){return true}b=d.length;g=d[0];e=d[b-1];c=b-2;return this._lineSegmentsIntersectsRange(e,g,c,1)}});a.FormatUtil={tryFunc:function(){var f=null;for(var d=0,b=arguments.length;d<b;d++){var c=arguments[d];try{f=c();break}catch(g){}}return f},bind:function(d,c){var b=Array.prototype.slice.apply(arguments,[2]);return function(){var e=b.concat(Array.prototype.slice.apply(arguments,[0]));return d.apply(c,e)}},applyDefaults:function(e,d){e=e||{};var c=typeof window.Event=="function"&&d instanceof window.Event;for(var b in d){if(e[b]===undefined||(!c&&d.hasOwnProperty&&d.hasOwnProperty(b)&&!e.hasOwnProperty(b))){e[b]=d[b]}}if(!c&&d&&d.hasOwnProperty&&d.hasOwnProperty("toString")&&!e.hasOwnProperty("toString")){e.toString=d.toString}return e}};a.Util.writeGeometryToWKT=function(h,f){var g;if(f=="point"){g="POLYGON("+h.lng+" "+h.lat+")"}else{if(f=="line"){g="LINESTRING(";var e=[];for(var d=0;d<h.length;d++){e.push(h[d].lng+" "+h[d].lat)}g+=e.join(",");g+=")"}else{if(f=="polygon"){g="POLYGON(";var b=[];for(var d=0;d<h.length;d++){var e=[];for(var c=0;c<h[d].length;c++){e.push(h[d][c].lng+" "+h[d][c].lat)}b.push("("+e.join(",")+")")}g+=b.join(",");g+=")"}}}return g};a.Util.getParam=function(g){var c=document.location.search.substring(1);var e=c.split("&");for(var b=0;b<e.length;b++){var d=e[b];if(d.indexOf(g+"=")==0){var f=d.substring(g.length+1);return decodeURIComponent(f)}}};a._LeafletCallbacks={};a.Request={support:!!(window.XMLHttpRequest&&"withCredentials" in new XMLHttpRequest()),callbacks:0,serialize:function(g){var e="";for(var b in g){if(b=="async"){continue}if(g.hasOwnProperty(b)){var f=g[b];var c=Object.prototype.toString.call(f);var d;if(e.length){e+="&"}if(c==="[object Array]"){d=(Object.prototype.toString.call(f[0])==="[object Object]")?JSON.stringify(f):f.join(",")}else{if(c==="[object Object]"){d=JSON.stringify(f)}else{if(c==="[object Date]"){d=f.valueOf()}else{d=f}}}e+=encodeURIComponent(b)+"="+encodeURIComponent(d)}}return e},createRequest:function(e,c,d){var b=new XMLHttpRequest();b.onerror=function(f){b.onreadystatechange=a.Util.falseFn;e.call(c,{error:{code:500,message:"XMLHttpRequest error"}},null)};b.onreadystatechange=function(){var f;var g;if(b.readyState===4){if(d=="json"){f=JSON.parse(b.responseText)}else{f=b.responseText}if(!g&&f.error){g=f.error;f=null}b.onerror=a.Util.falseFn;e.call(c,f,g)}};return b},request:function(b,e,i,c){var d=a.Request.serialize(e);var f=a.Request.createRequest(i,c);if(d!=""){if(b.indexOf("proxy.jsp?")!=-1){var j=b.replace("proxy.jsp?","");if(j.indexOf("?")!=-1){b+="&"+d}else{b+="?"+d}}else{if(b.indexOf("?")!=-1){b+="&"+d}else{b+="?"+d}}}var h=b.length;var g=true;if(e){g=e.async}if(h<=2000&&a.Request.support){f.open("GET",b,g);f.send(null)}else{if(h>2000&&a.Request.support){f.open("POST",b,g);f.setRequestHeader("Content-Type","application/x-www-form-urlencoded");f.send(d)}else{if(h<=2000&&!a.Request.support){return a.Request.get.JSONP(b,e,i,c)}}}return f},post:{XMLHTTP:function(c,f,g,d){var b=a.Request.createRequest(g,d);var e=true;if(f){e=f.async}b.open("POST",c,e);b.setRequestHeader("Content-Type","application/x-www-form-urlencoded");b.send(a.Request.serialize(f));return b}},get:{CORS:function(d,h,i,e){var g=a.Request.serialize(h);var c=a.Request.createRequest(i,e);if(g!=""){if(d.indexOf("proxy.jsp?")!=-1){var b=d.replace("proxy.jsp?","");if(b.indexOf("?")!=-1){d+="&"+g}else{d+="?"+g}}else{if(d.indexOf("?")!=-1){d+="&"+g}else{d+="?"+g}}}var f=true;if(h){f=h.async}c.open("GET",d,f);c.send(null);return c},JSON:function(d,h,i,e){var g=a.Request.serialize(h);var c=a.Request.createRequest(i,e,"json");if(g!=""){if(d.indexOf("proxy.jsp?")!=-1){var b=d.replace("proxy.jsp?","");if(b.indexOf("?")!=-1){d+="&"+g}else{d+="?"+g}}else{if(d.indexOf("?")!=-1){d+="&"+g}else{d+="?"+g}}}var f=true;if(h){f=h.async}c.open("GET",d,f);c.send(null);return c},JSONP:function(c,f,g,d){var e="c"+a.Request.callbacks;f=f?f:{};f.callback="L._LeafletCallbacks."+e;var b=a.DomUtil.create("script",null,document.body);b.type="text/javascript";if(c.indexOf("?")!=-1){b.src=c+"&"+a.Request.serialize(f)}else{b.src=c+"?"+a.Request.serialize(f)}b.id=e;a._LeafletCallbacks[e]=function(h){if(a._LeafletCallbacks[e]!==true){var j;var i=Object.prototype.toString.call(h);if(!(i==="[object Object]"||i==="[object Array]")){j={error:{code:500,message:"Expected array or object as JSONP response"}};h=null}if(!j&&h.error){j=h;h=null}g.call(d,h,j);a._LeafletCallbacks[e]=true}};a.Request.callbacks++;return{id:e,url:b.src,abort:function(){a._LeafletCallbacks._callback[e]({code:0,message:"Request aborted."})}}}}};a.get=(a.Request.support)?a.Request.get.CORS:a.Request.get.JSONP;a.getJSON=a.Request.get.JSON;a.jsonp=a.Request.get.JSONP;a.post=a.Request.post.XMLHTTP;a.request=a.Request.request;a.drawLocal={draw:{toolbar:{actions:{title:"取消绘制",text:"取消"},finish:{title:"完成绘制",text:"完成"},undo:{title:"清除最后一个绘制点",text:"清除最后一个点"},buttons:{polyline:"绘制折线",polygon:"绘制多边形",rectangle:"绘制矩形",circle:"绘制圆形",marker:"绘制标注"}},handlers:{circle:{tooltip:{start:"点击并且拖动绘制圆形"},radius:"半径"},marker:{tooltip:{start:"点击地图放置标记"}},polygon:{tooltip:{start:"点击开始绘制面",cont:"点击继续绘制面",end:"点击起点或双击结束绘制"}},polyline:{error:"<strong>错误:</strong> 形状边缘不能交叉!",tooltip:{start:"点击开始绘制线",cont:"点击继续绘制线",end:"点击最后一个点或双击结束绘制"}},rectangle:{tooltip:{start:"点击并且拖动绘制矩形"}},simpleshape:{tooltip:{end:"松开鼠标完成绘制"}}}},edit:{toolbar:{actions:{save:{title:"保存编辑",text:"保存"},cancel:{title:"取消编辑",text:"取消"}},buttons:{edit:"编辑图层",editDisabled:"没有可编辑的图层",remove:"删除图层",removeDisabled:"没有可删除的图层"}},handlers:{edit:{tooltip:{text:"拖动编辑要素",subtext:""}},remove:{tooltip:{text:"点击一个要素删除它"}}}}};a.Edit={};a.Draw={};a.Draw.Feature=a.Handler.extend({includes:a.Mixin.Events,initialize:function(c,b){this._map=c;this._container=c._container;this._overlayPane=c._panes.overlayPane;this._popupPane=c._panes.popupPane;if(b&&b.shapeOptions){b.shapeOptions=a.Util.extend({},this.options.shapeOptions,b.shapeOptions)}a.setOptions(this,b)},enable:function(){if(this._enabled){return}a.Handler.prototype.enable.call(this);this.fire("enabled",{handler:this.type});this._map.fire("draw:drawstart",{layerType:this.type})},disable:function(){if(!this._enabled){return}a.Handler.prototype.disable.call(this);this._map.fire("draw:drawstop",{layerType:this.type});this.fire("disabled",{handler:this.type})},addHooks:function(){var b=this._map;if(b){a.DomUtil.disableTextSelection();b.getContainer().focus();this._tooltip=new a.Drawtip(this._map);a.DomEvent.on(this._container,"keyup",this._cancelDrawing,this)}},removeHooks:function(){if(this._map){a.DomUtil.enableTextSelection();this._tooltip.dispose();this._tooltip=null;a.DomEvent.off(this._container,"keyup",this._cancelDrawing,this)}},setOptions:function(b){a.setOptions(this,b)},_fireCreatedEvent:function(b){this._map.fire("draw:created",{layer:b,layerType:this.type})},_cancelDrawing:function(b){this._map.fire("draw:canceled",{layerType:this.type});if(b.keyCode===27){this.disable()}}});a.Draw.Polyline=a.Draw.Feature.extend({statics:{TYPE:"polyline"},Poly:a.Polyline,options:{allowIntersection:true,repeatMode:false,drawError:{color:"#b00b00",timeout:2500},icon:new a.DivIcon({iconSize:new a.Point(8,8),className:"leaflet-div-icon leaflet-editing-icon"}),touchIcon:new a.DivIcon({iconSize:new a.Point(20,20),className:"leaflet-div-icon leaflet-editing-icon leaflet-touch-icon"}),guidelineDistance:20,maxGuideLineLength:4000,shapeOptions:{stroke:true,color:"#f06eaa",weight:4,opacity:0.5,fill:false,clickable:true},metric:true,feet:true,showLength:true,zIndexOffset:2000},initialize:function(c,b){if(a.Browser.touch){this.options.icon=this.options.touchIcon}this.options.drawError.message=a.drawLocal.draw.handlers.polyline.error;if(b&&b.drawError){b.drawError=a.Util.extend({},this.options.drawError,b.drawError)}this.type=a.Draw.Polyline.TYPE;a.Draw.Feature.prototype.initialize.call(this,c,b)},addHooks:function(){a.Draw.Feature.prototype.addHooks.call(this);if(this._map){this._markers=[];this._markerGroup=new a.LayerGroup();this._map.addLayer(this._markerGroup);this._poly=new a.Polyline([],this.options.shapeOptions);this._tooltip.updateContent(this._getTooltipText());if(!this._mouseMarker){this._mouseMarker=a.marker(this._map.getCenter(),{icon:a.divIcon({className:"leaflet-mouse-marker",iconAnchor:[20,20],iconSize:[40,40]}),opacity:0,zIndexOffset:this.options.zIndexOffset})}if(!a.Browser.touch){this._map.on("mouseup",this._onMouseUp,this)}this._mouseMarker.on("mousedown",this._onMouseDown,this).on("mouseout",this._onMouseOut,this).on("mouseup",this._onMouseUp,this).on("mousemove",this._onMouseMove,this).addTo(this._map);this._map.on("mouseup",this._onMouseUp,this).on("mousemove",this._onMouseMove,this).on("zoomlevelschange",this._onZoomEnd,this).on("click",this._onTouch,this).on("zoomend",this._onZoomEnd,this)}},removeHooks:function(){a.Draw.Feature.prototype.removeHooks.call(this);this._clearHideErrorTimeout();this._cleanUpShape();this._map.removeLayer(this._markerGroup);delete this._markerGroup;delete this._markers;this._map.removeLayer(this._poly);delete this._poly;this._mouseMarker.off("mousedown",this._onMouseDown,this).off("mouseout",this._onMouseOut,this).off("mouseup",this._onMouseUp,this).off("mousemove",this._onMouseMove,this);this._map.removeLayer(this._mouseMarker);delete this._mouseMarker;this._clearGuides();this._map.off("mouseup",this._onMouseUp,this).off("mousemove",this._onMouseMove,this).off("zoomlevelschange",this._onZoomEnd,this).off("zoomend",this._onZoomEnd,this).off("click",this._onTouch,this)},deleteLastVertex:function(){if(this._markers.length<=1){return}var c=this._markers.pop(),b=this._poly,d=this._poly.spliceLatLngs(b.getLatLngs().length-1,1)[0];this._markerGroup.removeLayer(c);if(b.getLatLngs().length<2){this._map.removeLayer(b)}this._vertexChanged(d,false)},addVertex:function(c){var b=this._markers.length;if(b>0&&!this.options.allowIntersection&&this._poly.newLatLngIntersects(c)){this._showErrorTooltip();return}else{if(this._errorShown){this._hideErrorTooltip()}}this._markers.push(this._createMarker(c));this._poly.addLatLng(c);if(this._poly.getLatLngs().length===2){this._map.addLayer(this._poly)}this._vertexChanged(c,true)},completeShape:function(){if(this._markers.length<=1){return}this._fireCreatedEvent();this.disable();if(this.options.repeatMode){this.enable()}},_finishShape:function(){var b=this._poly.newLatLngIntersects(this._poly.getLatLngs()[this._poly.getLatLngs().length-1]);if((!this.options.allowIntersection&&b)||!this._shapeIsValid()){this._showErrorTooltip();return}this._fireCreatedEvent();this.disable();if(this.options.repeatMode){this.enable()}},_shapeIsValid:function(){return true},_onZoomEnd:function(){if(this._markers!==null){this._updateGuide()}},_onMouseMove:function(c){var b=this._map.mouseEventToLayerPoint(c.originalEvent);var d=this._map.layerPointToLatLng(b);this._currentLatLng=d;this._updateTooltip(d);this._updateGuide(b);this._mouseMarker.setLatLng(d);a.DomEvent.preventDefault(c.originalEvent)},_vertexChanged:function(c,b){this._map.fire("draw:drawvertex",{layers:this._markerGroup});this._updateFinishHandler();this._updateRunningMeasure(c,b);this._clearGuides();this._updateTooltip()},_onMouseDown:function(c){var b=c.originalEvent;this._mouseDownOrigin=a.point(b.clientX,b.clientY)},_onMouseUp:function(b){if(this._mouseDownOrigin){var c=a.point(b.originalEvent.clientX,b.originalEvent.clientY).distanceTo(this._mouseDownOrigin);if(Math.abs(c)<9*(window.devicePixelRatio||1)){this.addVertex(b.latlng)}}this._mouseDownOrigin=null},_onTouch:function(b){if(a.Browser.touch){this._onMouseDown(b);this._onMouseUp(b)}},_onMouseOut:function(){if(this._tooltip){this._tooltip._onMouseOut.call(this._tooltip)}},_updateFinishHandler:function(){var b=this._markers.length;if(b>1){this._markers[b-1].on("click",this._finishShape,this)}if(b>2){this._markers[b-2].off("click",this._finishShape,this)}},_createMarker:function(c){var b=new a.Marker(c,{icon:this.options.icon,zIndexOffset:this.options.zIndexOffset*2});this._markerGroup.addLayer(b);return b},_updateGuide:function(c){var b=this._markers?this._markers.length:0;if(b>0){c=c||this._map.latLngToLayerPoint(this._currentLatLng);this._clearGuides();this._drawGuide(this._map.latLngToLayerPoint(this._markers[b-1].getLatLng()),c)}},_updateTooltip:function(b){var c=this._getTooltipText();if(b){this._tooltip.updatePosition(b)}if(!this._errorShown){this._tooltip.updateContent(c)}},_drawGuide:function(b,k){var c=Math.floor(Math.sqrt(Math.pow((k.x-b.x),2)+Math.pow((k.y-b.y),2))),f=this.options.guidelineDistance,h=this.options.maxGuideLineLength,d=c>h?c-h:f,j,g,e;if(!this._guidesContainer){this._guidesContainer=a.DomUtil.create("div","leaflet-draw-guides",this._overlayPane)}for(;d<c;d+=this.options.guidelineDistance){j=d/c;g={x:Math.floor((b.x*(1-j))+(j*k.x)),y:Math.floor((b.y*(1-j))+(j*k.y))};e=a.DomUtil.create("div","leaflet-draw-guide-dash",this._guidesContainer);e.style.backgroundColor=!this._errorShown?this.options.shapeOptions.color:this.options.drawError.color;a.DomUtil.setPosition(e,g)}},_updateGuideColor:function(c){if(this._guidesContainer){for(var d=0,b=this._guidesContainer.childNodes.length;d<b;d++){this._guidesContainer.childNodes[d].style.backgroundColor=c}}},_clearGuides:function(){if(this._guidesContainer){while(this._guidesContainer.firstChild){this._guidesContainer.removeChild(this._guidesContainer.firstChild)}}},_getTooltipText:function(){var b=this.options.showLength,c,d;if(this._markers.length===0){c={text:a.drawLocal.draw.handlers.polyline.tooltip.start}}else{d=b?this._getMeasurementString():"";if(this._markers.length===1){c={text:a.drawLocal.draw.handlers.polyline.tooltip.cont,subtext:d}}else{c={text:a.drawLocal.draw.handlers.polyline.tooltip.end,subtext:d}}}return c},_updateRunningMeasure:function(f,d){var b=this._markers.length,c,e;if(this._markers.length===1){this._measurementRunningTotal=0}else{c=b-(d?2:1);e=f.distanceTo(this._markers[c].getLatLng());this._measurementRunningTotal+=e*(d?1:-1)}},_getMeasurementString:function(){var c=this._currentLatLng,b=this._markers[this._markers.length-1].getLatLng(),d;d=this._measurementRunningTotal+c.distanceTo(b);return a.GeometryUtil.readableDistance(d,this.options.metric,this.options.feet)},_showErrorTooltip:function(){this._errorShown=true;this._tooltip.showAsError().updateContent({text:this.options.drawError.message});this._updateGuideColor(this.options.drawError.color);this._poly.setStyle({color:this.options.drawError.color});this._clearHideErrorTimeout();this._hideErrorTimeout=setTimeout(a.Util.bind(this._hideErrorTooltip,this),this.options.drawError.timeout)},_hideErrorTooltip:function(){this._errorShown=false;this._clearHideErrorTimeout();this._tooltip.removeError().updateContent(this._getTooltipText());this._updateGuideColor(this.options.shapeOptions.color);this._poly.setStyle({color:this.options.shapeOptions.color})},_clearHideErrorTimeout:function(){if(this._hideErrorTimeout){clearTimeout(this._hideErrorTimeout);this._hideErrorTimeout=null}},_cleanUpShape:function(){if(this._markers.length>1){this._markers[this._markers.length-1].off("click",this._finishShape,this)}},_fireCreatedEvent:function(){var b=new this.Poly(this._poly.getLatLngs(),this.options.shapeOptions);a.Draw.Feature.prototype._fireCreatedEvent.call(this,b)}});a.Draw.Polygon=a.Draw.Polyline.extend({statics:{TYPE:"polygon"},Poly:a.Polygon,options:{showArea:false,shapeOptions:{stroke:true,color:"#f06eaa",weight:4,opacity:0.5,fill:true,fillColor:null,fillOpacity:0.2,clickable:true},metric:true},initialize:function(c,b){a.Draw.Polyline.prototype.initialize.call(this,c,b);this.type=a.Draw.Polygon.TYPE},_updateFinishHandler:function(){var b=this._markers.length;if(b===1){this._markers[0].on("click",this._finishShape,this)}if(b>2){this._markers[b-1].on("dblclick",this._finishShape,this);if(b>3){this._markers[b-2].off("dblclick",this._finishShape,this)}}},_getTooltipText:function(){var c,b;if(this._markers.length===0){c=a.drawLocal.draw.handlers.polygon.tooltip.start}else{if(this._markers.length<3){c=a.drawLocal.draw.handlers.polygon.tooltip.cont}else{c=a.drawLocal.draw.handlers.polygon.tooltip.end;b=this._getMeasurementString()}}return{text:c,subtext:b}},_getMeasurementString:function(){var b=this._area;if(!b){return null}return a.GeometryUtil.readableArea(b,this.options.metric)},_shapeIsValid:function(){return this._markers.length>=3},_vertexChanged:function(d,b){var c;if(!this.options.allowIntersection&&this.options.showArea){c=this._poly.getLatLngs();this._area=a.GeometryUtil.geodesicArea(c)}a.Draw.Polyline.prototype._vertexChanged.call(this,d,b)},_cleanUpShape:function(){var b=this._markers.length;if(b>0){this._markers[0].off("click",this._finishShape,this);if(b>2){this._markers[b-1].off("dblclick",this._finishShape,this)}}}});a.Draw.SimpleShape=a.Draw.Feature.extend({options:{repeatMode:false},initialize:function(c,b){this._endLabelText=a.drawLocal.draw.handlers.simpleshape.tooltip.end;a.Draw.Feature.prototype.initialize.call(this,c,b)},addHooks:function(){a.Draw.Feature.prototype.addHooks.call(this);if(this._map){this._mapDraggable=this._map.dragging.enabled();if(this._mapDraggable){this._map.dragging.disable()}this._container.style.cursor="crosshair";this._tooltip.updateContent({text:this._initialLabelText});this._map.on("mousedown",this._onMouseDown,this).on("mousemove",this._onMouseMove,this).on("touchstart",this._onMouseDown,this).on("touchmove",this._onMouseMove,this)}},removeHooks:function(){a.Draw.Feature.prototype.removeHooks.call(this);if(this._map){if(this._mapDraggable){this._map.dragging.enable()}this._container.style.cursor="";this._map.off("mousedown",this._onMouseDown,this).off("mousemove",this._onMouseMove,this).off("touchstart",this._onMouseDown,this).off("touchmove",this._onMouseMove,this);a.DomEvent.off(document,"mouseup",this._onMouseUp,this);a.DomEvent.off(document,"touchend",this._onMouseUp,this);if(this._shape){this._map.removeLayer(this._shape);delete this._shape}}this._isDrawing=false},_getTooltipText:function(){return{text:this._endLabelText}},_onMouseDown:function(b){this._isDrawing=true;this._startLatLng=b.latlng;a.DomEvent.on(document,"mouseup",this._onMouseUp,this).on(document,"touchend",this._onMouseUp,this).preventDefault(b.originalEvent)},_onMouseMove:function(b){var c=b.latlng;this._tooltip.updatePosition(c);if(this._isDrawing){this._tooltip.updateContent(this._getTooltipText());this._drawShape(c)}},_onMouseUp:function(){if(this._shape){this._fireCreatedEvent()}this.disable();if(this.options.repeatMode){this.enable()}}});a.Draw.Rectangle=a.Draw.SimpleShape.extend({statics:{TYPE:"rectangle"},options:{shapeOptions:{stroke:true,color:"#f06eaa",weight:4,opacity:0.5,fill:true,fillColor:null,fillOpacity:0.2,clickable:true},metric:true},initialize:function(c,b){this.type=a.Draw.Rectangle.TYPE;this._initialLabelText=a.drawLocal.draw.handlers.rectangle.tooltip.start;a.Draw.SimpleShape.prototype.initialize.call(this,c,b)},_drawShape:function(b){if(!this._shape){this._shape=new a.Rectangle(new a.LatLngBounds(this._startLatLng,b),this.options.shapeOptions);this._map.addLayer(this._shape)}else{this._shape.setBounds(new a.LatLngBounds(this._startLatLng,b))}},_fireCreatedEvent:function(){var b=new a.Rectangle(this._shape.getBounds(),this.options.shapeOptions);a.Draw.SimpleShape.prototype._fireCreatedEvent.call(this,b)},_getTooltipText:function(){var f=a.Draw.SimpleShape.prototype._getTooltipText.call(this),b=this._shape,e,d,c;if(b){e=this._shape.getLatLngs();d=a.GeometryUtil.geodesicArea(e);c=a.GeometryUtil.readableArea(d,this.options.metric)}return{text:f.text,subtext:c}}});a.Draw.Circle=a.Draw.SimpleShape.extend({statics:{TYPE:"circle"},options:{shapeOptions:{stroke:true,color:"#f06eaa",weight:4,opacity:0.5,fill:true,fillColor:null,fillOpacity:0.2,clickable:true},showRadius:true,metric:true,feet:true},initialize:function(c,b){this.type=a.Draw.Circle.TYPE;this._initialLabelText=a.drawLocal.draw.handlers.circle.tooltip.start;a.Draw.SimpleShape.prototype.initialize.call(this,c,b)},_drawShape:function(b){if(!this._shape){this._shape=new a.Circle(this._startLatLng,this._startLatLng.distanceTo(b),this.options.shapeOptions);this._map.addLayer(this._shape)}else{this._shape.setRadius(this._startLatLng.distanceTo(b))}},_fireCreatedEvent:function(){var b=new a.Circle(this._startLatLng,this._shape.getRadius(),this.options.shapeOptions);a.Draw.SimpleShape.prototype._fireCreatedEvent.call(this,b)},_onMouseMove:function(d){var g=d.latlng,c=this.options.showRadius,f=this.options.metric,b;this._tooltip.updatePosition(g);if(this._isDrawing){this._drawShape(g);b=this._shape.getRadius().toFixed(1);this._tooltip.updateContent({text:this._endLabelText,subtext:c?a.drawLocal.draw.handlers.circle.radius+": "+a.GeometryUtil.readableDistance(b,f,this.options.feet):""})}}});a.Draw.Marker=a.Draw.Feature.extend({statics:{TYPE:"marker"},options:{icon:new a.Icon.Default(),repeatMode:false,zIndexOffset:2000},initialize:function(c,b){this.type=a.Draw.Marker.TYPE;a.Draw.Feature.prototype.initialize.call(this,c,b)},addHooks:function(){a.Draw.Feature.prototype.addHooks.call(this);if(this._map){this._tooltip.updateContent({text:a.drawLocal.draw.handlers.marker.tooltip.start});if(!this._mouseMarker){this._mouseMarker=a.marker(this._map.getCenter(),{icon:a.divIcon({className:"leaflet-mouse-marker",iconAnchor:[20,20],iconSize:[40,40]}),opacity:0,zIndexOffset:this.options.zIndexOffset})}this._mouseMarker.on("click",this._onClick,this).addTo(this._map);this._map.on("mousemove",this._onMouseMove,this);this._map.on("click",this._onTouch,this)}},removeHooks:function(){a.Draw.Feature.prototype.removeHooks.call(this);if(this._map){if(this._marker){this._marker.off("click",this._onClick,this);this._map.off("click",this._onClick,this).off("click",this._onTouch,this).removeLayer(this._marker);delete this._marker}this._mouseMarker.off("click",this._onClick,this);this._map.removeLayer(this._mouseMarker);delete this._mouseMarker;this._map.off("mousemove",this._onMouseMove,this)}},_onMouseMove:function(b){var c=b.latlng;this._tooltip.updatePosition(c);this._mouseMarker.setLatLng(c);if(!this._marker){this._marker=new a.Marker(c,{icon:this.options.icon,zIndexOffset:this.options.zIndexOffset});this._marker.on("click",this._onClick,this);this._map.on("click",this._onClick,this).addLayer(this._marker)}else{c=this._mouseMarker.getLatLng();this._marker.setLatLng(c)}},_onClick:function(){this._fireCreatedEvent();this.disable();if(this.options.repeatMode){this.enable()}},_onTouch:function(b){this._onMouseMove(b);this._onClick()},_fireCreatedEvent:function(){var b=new a.Marker(this._marker.getLatLng(),{icon:this.options.icon});a.Draw.Feature.prototype._fireCreatedEvent.call(this,b)}});a.Edit.Marker=a.Handler.extend({initialize:function(b,c){this._marker=b;a.setOptions(this,c)},addHooks:function(){var b=this._marker;b.dragging.enable();b.on("dragend",this._onDragEnd,b);this._toggleMarkerHighlight()},removeHooks:function(){var b=this._marker;b.dragging.disable();b.off("dragend",this._onDragEnd,b);this._toggleMarkerHighlight()},_onDragEnd:function(c){var b=c.target;b.edited=true;this._map.fire("draw:editmove",{layer:b})},_toggleMarkerHighlight:function(){var b=this._marker._icon;if(!b){return}b.style.display="none";if(a.DomUtil.hasClass(b,"leaflet-edit-marker-selected")){a.DomUtil.removeClass(b,"leaflet-edit-marker-selected");this._offsetMarker(b,-4)}else{a.DomUtil.addClass(b,"leaflet-edit-marker-selected");this._offsetMarker(b,4)}b.style.display=""},_offsetMarker:function(c,e){var d=parseInt(c.style.marginTop,10)-e,b=parseInt(c.style.marginLeft,10)-e;c.style.marginTop=d+"px";c.style.marginLeft=b+"px"}});a.Marker.addInitHook(function(){if(a.Edit.Marker){this.editing=new a.Edit.Marker(this);if(this.options.editable){this.editing.enable()}}});a.Edit.Poly=a.Handler.extend({options:{},initialize:function(c,b){if(c._latlngs.length>1){this.latlngs=[c._latlngs]}else{this.latlngs=c._latlngs}if(c._holes){this.latlngs=this.latlngs.concat(c._holes)}this._poly=c;a.setOptions(this,b);this._poly.on("revert-edited",this._updateLatLngs,this)},_eachVertexHandler:function(c){for(var b=0;b<this._verticesHandlers.length;b++){c(this._verticesHandlers[b])}},addHooks:function(){this._initHandlers();this._eachVertexHandler(function(b){b.addHooks()})},removeHooks:function(){this._eachVertexHandler(function(b){b.removeHooks()})},updateMarkers:function(){this._eachVertexHandler(function(b){b.updateMarkers()})},_initHandlers:function(){this._verticesHandlers=[];for(var b=0;b<this.latlngs.length;b++){this._verticesHandlers.push(new a.Edit.PolyVerticesEdit(this._poly,this.latlngs[b],this.options))}},_updateLatLngs:function(b){this.latlngs=[b.layer._latlngs];if(b.layer._holes){this.latlngs=this.latlngs.concat(b.layer._holes)}}});a.Edit.PolyVerticesEdit=a.Handler.extend({options:{icon:new a.DivIcon({iconSize:new a.Point(8,8),className:"leaflet-div-icon leaflet-editing-icon"}),touchIcon:new a.DivIcon({iconSize:new a.Point(20,20),className:"leaflet-div-icon leaflet-editing-icon leaflet-touch-icon"}),drawError:{color:"#b00b00",timeout:1000}},initialize:function(d,b,c){if(a.Browser.touch){this.options.icon=this.options.touchIcon}this._poly=d;if(c&&c.drawError){c.drawError=a.Util.extend({},this.options.drawError,c.drawError)}this._latlngs=b;a.setOptions(this,c)},addHooks:function(){var b=this._poly;if(!(b instanceof a.Polygon)){b.options.fill=false}b.setStyle(b.options.editing);if(this._poly._map){this._map=this._poly._map;if(!this._markerGroup){this._initMarkers()}this._poly._map.addLayer(this._markerGroup)}},removeHooks:function(){var b=this._poly;b.setStyle(b.options.original);if(b._map){b._map.removeLayer(this._markerGroup);delete this._markerGroup;delete this._markers}},updateMarkers:function(){this._markerGroup.clearLayers();this._initMarkers()},_initMarkers:function(){if(!this._markerGroup){this._markerGroup=new a.LayerGroup()}this._markers=[];var c=this._latlngs,h,g,b,d;for(h=0,b=c.length;h<b;h++){d=this._createMarker(c[h],h);d.on("click",this._onMarkerClick,this);this._markers.push(d)}var f,e;for(h=0,g=b-1;h<b;g=h++){if(h===0&&!(a.Polygon&&(this._poly instanceof a.Polygon))){continue}f=this._markers[g];e=this._markers[h];this._createMiddleMarker(f,e);this._updatePrevNext(f,e)}},_createMarker:function(d,c){var b=new a.Marker(d,{draggable:true,icon:this.options.icon,});b._origLatLng=d;b._index=c;b.on("dragstart",this._onMarkerDragStart,this).on("drag",this._onMarkerDrag,this).on("dragend",this._fireEdit,this).on("touchmove",this._onTouchMove,this).on("MSPointerMove",this._onTouchMove,this).on("touchend",this._fireEdit,this).on("MSPointerUp",this._fireEdit,this);this._markerGroup.addLayer(b);return b},_onMarkerDragStart:function(){this._poly.fire("editstart")},_spliceLatLngs:function(){var b=[].splice.apply(this._latlngs,arguments);this._poly._convertLatLngs(this._latlngs,true);this._poly.redraw();return b},_removeMarker:function(b){var c=b._index;this._markerGroup.removeLayer(b);this._markers.splice(c,1);this._spliceLatLngs(c,1);this._updateIndexes(c,-1);b.off("dragstart",this._onMarkerDragStart,this).off("drag",this._onMarkerDrag,this).off("dragend",this._fireEdit,this).off("touchmove",this._onMarkerDrag,this).off("touchend",this._fireEdit,this).off("click",this._onMarkerClick,this).off("MSPointerMove",this._onTouchMove,this).off("MSPointerUp",this._fireEdit,this)},_fireEdit:function(){this._poly.edited=true;this._poly.fire("edit");this._poly._map.fire("draw:editvertex",{layers:this._markerGroup})},_onMarkerDrag:function(g){var b=g.target;var f=this._poly;a.extend(b._origLatLng,b._latlng);if(b._middleLeft){b._middleLeft.setLatLng(this._getMiddleLatLng(b._prev,b))}if(b._middleRight){b._middleRight.setLatLng(this._getMiddleLatLng(b,b._next))}if(f.options.poly){var d=f._map._editTooltip;if(!f.options.poly.allowIntersection&&f.intersects()){var c=f.options.color;f.setStyle({color:this.options.drawError.color});if(d){d.updateContent({text:a.drawLocal.draw.handlers.polyline.error})}setTimeout(function(){f.setStyle({color:c});if(d){d.updateContent({text:a.drawLocal.edit.handlers.edit.tooltip.text,subtext:a.drawLocal.edit.handlers.edit.tooltip.subtext})}},1000);this._onMarkerClick(g)}}this._poly.redraw();this._poly.fire("editdrag")},_onMarkerClick:function(d){var c=a.Polygon&&(this._poly instanceof a.Polygon)?4:3,b=d.target;if(this._latlngs.length<c){return}this._removeMarker(b);this._updatePrevNext(b._prev,b._next);if(b._middleLeft){this._markerGroup.removeLayer(b._middleLeft)}if(b._middleRight){this._markerGroup.removeLayer(b._middleRight)}if(b._prev&&b._next){this._createMiddleMarker(b._prev,b._next)}else{if(!b._prev){b._next._middleLeft=null}else{if(!b._next){b._prev._middleRight=null}}}this._fireEdit()},_onTouchMove:function(d){var c=this._map.mouseEventToLayerPoint(d.originalEvent.touches[0]),f=this._map.layerPointToLatLng(c),b=d.target;a.extend(b._origLatLng,f);if(b._middleLeft){b._middleLeft.setLatLng(this._getMiddleLatLng(b._prev,b))}if(b._middleRight){b._middleRight.setLatLng(this._getMiddleLatLng(b,b._next))}this._poly.redraw();this.updateMarkers()},_updateIndexes:function(b,c){this._markerGroup.eachLayer(function(d){if(d._index>b){d._index+=c}})},_createMiddleMarker:function(g,e){var h=this._getMiddleLatLng(g,e),b=this._createMarker(h),f,d,c;b.setOpacity(0.6);g._middleRight=e._middleLeft=b;d=function(){b.off("touchmove",d,this);var j=e._index;b._index=j;b.off("click",f,this).on("click",this._onMarkerClick,this);h.lat=b.getLatLng().lat;h.lng=b.getLatLng().lng;this._spliceLatLngs(j,0,h);this._markers.splice(j,0,b);b.setOpacity(1);this._updateIndexes(j,1);e._index++;this._updatePrevNext(g,b);this._updatePrevNext(b,e);this._poly.fire("editstart")};c=function(){b.off("dragstart",d,this);b.off("dragend",c,this);b.off("touchmove",d,this);this._createMiddleMarker(g,b);this._createMiddleMarker(b,e)};f=function(){d.call(this);c.call(this);this._fireEdit()};b.on("click",f,this).on("dragstart",d,this).on("dragend",c,this).on("touchmove",d,this);this._markerGroup.addLayer(b)},_updatePrevNext:function(c,b){if(c){c._next=b}if(b){b._prev=c}},_getMiddleLatLng:function(f,d){var c=this._poly._map,e=c.project(f.getLatLng()),b=c.project(d.getLatLng());return c.unproject(e._add(b)._divideBy(2))}});a.Polyline.addInitHook(function(){if(this.editing){return}if(a.Edit.Poly){this.editing=new a.Edit.Poly(this,this.options.poly);if(this.options.editable){this.editing.enable()}}this.on("add",function(){if(this.editing&&this.editing.enabled()){this.editing.addHooks()}});this.on("remove",function(){if(this.editing&&this.editing.enabled()){this.editing.removeHooks()}})});a.Edit.SimpleShape=a.Handler.extend({options:{moveIcon:new a.DivIcon({iconSize:new a.Point(8,8),className:"leaflet-div-icon leaflet-editing-icon leaflet-edit-move"}),resizeIcon:new a.DivIcon({iconSize:new a.Point(8,8),className:"leaflet-div-icon leaflet-editing-icon leaflet-edit-resize"}),touchMoveIcon:new a.DivIcon({iconSize:new a.Point(20,20),className:"leaflet-div-icon leaflet-editing-icon leaflet-edit-move leaflet-touch-icon"}),touchResizeIcon:new a.DivIcon({iconSize:new a.Point(20,20),className:"leaflet-div-icon leaflet-editing-icon leaflet-edit-resize leaflet-touch-icon"}),},initialize:function(b,c){if(a.Browser.touch){this.options.moveIcon=this.options.touchMoveIcon;this.options.resizeIcon=this.options.touchResizeIcon}this._shape=b;a.Util.setOptions(this,c)},addHooks:function(){var b=this._shape;if(this._shape._map){this._map=this._shape._map;b.setStyle(b.options.editing);if(b._map){this._map=b._map;if(!this._markerGroup){this._initMarkers()}this._map.addLayer(this._markerGroup)}}},removeHooks:function(){var c=this._shape;c.setStyle(c.options.original);if(c._map){this._unbindMarker(this._moveMarker);for(var d=0,b=this._resizeMarkers.length;d<b;d++){this._unbindMarker(this._resizeMarkers[d])}this._resizeMarkers=null;this._map.removeLayer(this._markerGroup);delete this._markerGroup}this._map=null},updateMarkers:function(){this._markerGroup.clearLayers();this._initMarkers()},_initMarkers:function(){if(!this._markerGroup){this._markerGroup=new a.LayerGroup()}this._createMoveMarker();this._createResizeMarker()},_createMoveMarker:function(){},_createResizeMarker:function(){},_createMarker:function(d,c){var b=new a.Marker(d,{draggable:true,icon:c,zIndexOffset:10});this._bindMarker(b);this._markerGroup.addLayer(b);return b},_bindMarker:function(b){b.on("dragstart",this._onMarkerDragStart,this).on("drag",this._onMarkerDrag,this).on("dragend",this._onMarkerDragEnd,this).on("touchstart",this._onTouchStart,this).on("touchmove",this._onTouchMove,this).on("MSPointerMove",this._onTouchMove,this).on("touchend",this._onTouchEnd,this).on("MSPointerUp",this._onTouchEnd,this)},_unbindMarker:function(b){b.off("dragstart",this._onMarkerDragStart,this).off("drag",this._onMarkerDrag,this).off("dragend",this._onMarkerDragEnd,this).off("touchstart",this._onTouchStart,this).off("touchmove",this._onTouchMove,this).off("MSPointerMove",this._onTouchMove,this).off("touchend",this._onTouchEnd,this).off("MSPointerUp",this._onTouchEnd,this)},_onMarkerDragStart:function(c){var b=c.target;b.setOpacity(0);this._shape.fire("editstart")},_fireEdit:function(){this._shape.edited=true;this._shape.fire("edit")},_onMarkerDrag:function(c){var b=c.target,d=b.getLatLng();if(b===this._moveMarker){this._move(d)}else{this._resize(d)}this._shape.redraw();this._shape.fire("editdrag")},_onMarkerDragEnd:function(c){var b=c.target;b.setOpacity(1);this._fireEdit()},_onTouchStart:function(f){a.Edit.SimpleShape.prototype._onMarkerDragStart.call(this,f);if(typeof(this._getCorners)==="function"){var c=this._getCorners(),b=f.target,d=b._cornerIndex;b.setOpacity(0);this._oppositeCorner=c[(d+2)%4];this._toggleCornerMarkers(0,d)}this._shape.fire("editstart")},_onTouchMove:function(d){var c=this._map.mouseEventToLayerPoint(d.originalEvent.touches[0]),f=this._map.layerPointToLatLng(c),b=d.target;if(b===this._moveMarker){this._move(f)}else{this._resize(f)}this._shape.redraw();return false},_onTouchEnd:function(c){var b=c.target;b.setOpacity(1);this.updateMarkers();this._fireEdit()},_move:function(){},_resize:function(){}});a.Edit.Rectangle=a.Edit.SimpleShape.extend({_createMoveMarker:function(){var c=this._shape.getBounds(),b=c.getCenter();this._moveMarker=this._createMarker(b,this.options.moveIcon)},_createResizeMarker:function(){var c=this._getCorners();this._resizeMarkers=[];for(var d=0,b=c.length;d<b;d++){this._resizeMarkers.push(this._createMarker(c[d],this.options.resizeIcon));this._resizeMarkers[d]._cornerIndex=d}},_onMarkerDragStart:function(f){a.Edit.SimpleShape.prototype._onMarkerDragStart.call(this,f);var c=this._getCorners(),b=f.target,d=b._cornerIndex;this._oppositeCorner=c[(d+2)%4];this._toggleCornerMarkers(0,d)},_onMarkerDragEnd:function(f){var c=f.target,d,b;if(c===this._moveMarker){d=this._shape.getBounds();b=d.getCenter();c.setLatLng(b)}this._toggleCornerMarkers(1);this._repositionCornerMarkers();a.Edit.SimpleShape.prototype._onMarkerDragEnd.call(this,f)},_move:function(e){var c=this._shape.getLatLngs(),h=this._shape.getBounds(),b=h.getCenter(),j,g=[];for(var f=0,d=c.length;f<d;f++){j=[c[f].lat-b.lat,c[f].lng-b.lng];g.push([e.lat+j[0],e.lng+j[1]])}this._shape.setLatLngs(g);this._repositionCornerMarkers();this._map.fire("draw:editmove",{layer:this._shape})},_resize:function(c){var b;this._shape.setBounds(a.latLngBounds(c,this._oppositeCorner));b=this._shape.getBounds();this._moveMarker.setLatLng(b.getCenter());this._map.fire("draw:editresize",{layer:this._shape})},_getCorners:function(){var d=this._shape.getBounds(),c=d.getNorthWest(),f=d.getNorthEast(),e=d.getSouthEast(),b=d.getSouthWest();return[c,f,e,b]},_toggleCornerMarkers:function(c){for(var d=0,b=this._resizeMarkers.length;d<b;d++){this._resizeMarkers[d].setOpacity(c)}},_repositionCornerMarkers:function(){var c=this._getCorners();for(var d=0,b=this._resizeMarkers.length;d<b;d++){this._resizeMarkers[d].setLatLng(c[d])}}});a.Rectangle.addInitHook(function(){if(a.Edit.Rectangle){this.editing=new a.Edit.Rectangle(this);if(this.options.editable){this.editing.enable()}}});a.Edit.Circle=a.Edit.SimpleShape.extend({_createMoveMarker:function(){var b=this._shape.getLatLng();this._moveMarker=this._createMarker(b,this.options.moveIcon)},_createResizeMarker:function(){var b=this._shape.getLatLng(),c=this._getResizeMarkerPoint(b);this._resizeMarkers=[];this._resizeMarkers.push(this._createMarker(c,this.options.resizeIcon))},_getResizeMarkerPoint:function(d){var c=this._shape._radius*Math.cos(Math.PI/4),b=this._map.project(d);return this._map.unproject([b.x+c,b.y-c])},_move:function(c){var b=this._getResizeMarkerPoint(c);this._resizeMarkers[0].setLatLng(b);this._shape.setLatLng(c);this._map.fire("draw:editmove",{layer:this._shape})},_resize:function(d){var c=this._moveMarker.getLatLng(),b=c.distanceTo(d);this._shape.setRadius(b);this._map.fire("draw:editresize",{layer:this._shape})}});a.Circle.addInitHook(function(){if(a.Edit.Circle){this.editing=new a.Edit.Circle(this);if(this.options.editable){this.editing.enable()}}this.on("add",function(){if(this.editing&&this.editing.enabled()){this.editing.addHooks()}});this.on("remove",function(){if(this.editing&&this.editing.enabled()){this.editing.removeHooks()}})});a.Drawtip=a.Class.extend({initialize:function(b){this._map=b;this._popupPane=b._panes.popupPane;this._container=b.options.drawControlTooltips?a.DomUtil.create("div","leaflet-draw-tooltip",this._popupPane):null;this._singleLineLabel=false;this._map.on("mouseout",this._onMouseOut,this)},dispose:function(){this._map.off("mouseout",this._onMouseOut,this);if(this._container){this._popupPane.removeChild(this._container);this._container=null}},updateContent:function(b){if(!this._container){return this}b.subtext=b.subtext||"";if(b.subtext.length===0&&!this._singleLineLabel){a.DomUtil.addClass(this._container,"leaflet-draw-tooltip-single");this._singleLineLabel=true}else{if(b.subtext.length>0&&this._singleLineLabel){a.DomUtil.removeClass(this._container,"leaflet-draw-tooltip-single");this._singleLineLabel=false}}this._container.innerHTML=(b.subtext.length>0?'<span class="leaflet-draw-tooltip-subtext">'+b.subtext+"</span><br />":"")+"<span>"+b.text+"</span>";return this},updatePosition:function(d){var c=this._map.latLngToLayerPoint(d),b=this._container;if(this._container){b.style.visibility="inherit";a.DomUtil.setPosition(b,c)}return this},showAsError:function(){if(this._container){a.DomUtil.addClass(this._container,"leaflet-error-draw-tooltip")}return this},removeError:function(){if(this._container){a.DomUtil.removeClass(this._container,"leaflet-error-draw-tooltip")}return this},_onMouseOut:function(){if(this._container){this._container.style.visibility="hidden"}}});a.Map.mergeOptions({drawControlTooltips:true});a.EditTool=a.EditTool||{};a.EditTool.Edit=a.Handler.extend({statics:{TYPE:"edit"},includes:a.Mixin.Events,initialize:function(c,b){a.Handler.prototype.initialize.call(this,c);a.setOptions(this,b);this._featureGroup=b.featureGroup;if(!(this._featureGroup instanceof a.FeatureGroup)){throw new Error("options.featureGroup must be a L.FeatureGroup")}this._uneditedLayerProps={};this.type=a.EditTool.Edit.TYPE},enable:function(){if(this._enabled||!this._hasAvailableLayers()){return}this.fire("enabled",{handler:this.type});this._map.fire("draw:editstart",{handler:this.type});a.Handler.prototype.enable.call(this);this._featureGroup.on("layeradd",this._enableLayerEdit,this).on("layerremove",this._disableLayerEdit,this)},disable:function(){if(!this._enabled){return}this._featureGroup.off("layeradd",this._enableLayerEdit,this).off("layerremove",this._disableLayerEdit,this);a.Handler.prototype.disable.call(this);this._map.fire("draw:editstop",{handler:this.type});this.fire("disabled",{handler:this.type})},addHooks:function(){var b=this._map;if(b){b.getContainer().focus();this._featureGroup.eachLayer(this._enableLayerEdit,this);this._tooltip=new a.Drawtip(this._map);this._tooltip.updateContent({text:a.drawLocal.edit.handlers.edit.tooltip.text,subtext:a.drawLocal.edit.handlers.edit.tooltip.subtext});b._editTooltip=this._tooltip;this._updateTooltip();this._map.on("mousemove",this._onMouseMove,this).on("touchmove",this._onMouseMove,this).on("MSPointerMove",this._onMouseMove,this).on("click",this._editStyle,this).on("draw:editvertex",this._updateTooltip,this)}},removeHooks:function(){if(this._map){this._featureGroup.eachLayer(this._disableLayerEdit,this);this._uneditedLayerProps={};this._tooltip.dispose();this._tooltip=null;this._map.off("mousemove",this._onMouseMove,this).off("touchmove",this._onMouseMove,this).off("MSPointerMove",this._onMouseMove,this).off("click",this._editStyle,this).off("draw:editvertex",this._updateTooltip,this)}},revertLayers:function(){this._featureGroup.eachLayer(function(b){this._revertLayer(b)},this)},save:function(){var b=new a.LayerGroup();this._featureGroup.eachLayer(function(c){if(c.edited){b.addLayer(c);c.edited=false}});this._map.fire("draw:edited",{layers:b})},_backupLayer:function(b){var c=a.Util.stamp(b);if(!this._uneditedLayerProps[c]){if(b instanceof a.Polyline||b instanceof a.Polygon||b instanceof a.Rectangle){this._uneditedLayerProps[c]={latlngs:a.LatLngUtil.cloneLatLngs(b.getLatLngs())}}else{if(b instanceof a.Circle){this._uneditedLayerProps[c]={latlng:a.LatLngUtil.cloneLatLng(b.getLatLng()),radius:b.getRadius()}}else{if(b instanceof a.Marker){this._uneditedLayerProps[c]={latlng:a.LatLngUtil.cloneLatLng(b.getLatLng())}}}}}},_getTooltipText:function(){return({text:a.drawLocal.edit.handlers.edit.tooltip.text,subtext:a.drawLocal.edit.handlers.edit.tooltip.subtext})},_updateTooltip:function(){this._tooltip.updateContent(this._getTooltipText())},_revertLayer:function(b){var c=a.Util.stamp(b);b.edited=false;if(this._uneditedLayerProps.hasOwnProperty(c)){if(b instanceof a.Polyline||b instanceof a.Polygon||b instanceof a.Rectangle){b.setLatLngs(this._uneditedLayerProps[c].latlngs)}else{if(b instanceof a.Circle){b.setLatLng(this._uneditedLayerProps[c].latlng);b.setRadius(this._uneditedLayerProps[c].radius)}else{if(b instanceof a.Marker){b.setLatLng(this._uneditedLayerProps[c].latlng)}}}b.fire("revert-edited",{layer:b})}},_enableLayerEdit:function(f){var c=f.layer||f.target||f,b,d;this._backupLayer(c);if(this.options.poly){d=a.Util.extend({},this.options.poly);c.options.poly=d}if(this.options.selectedPathOptions){b=a.Util.extend({},this.options.selectedPathOptions);if(b.maintainColor){b.color=c.options.color;b.fillColor=c.options.fillColor}c.options.original=a.extend({},c.options);c.options.editing=b}if(this.isMarker){c.dragging.enable();c.on("dragend",this._onMarkerDragEnd).on("touchmove",this._onTouchMove,this).on("MSPointerMove",this._onTouchMove,this).on("touchend",this._onMarkerDragEnd,this).on("MSPointerUp",this._onMarkerDragEnd,this)}else{c.editing.enable()}},_disableLayerEdit:function(c){var b=c.layer||c.target||c;b.edited=false;b.editing.disable();delete b.options.editing;delete b.options.original;if(this._selectedPathOptions){if(b instanceof a.Marker){this._toggleMarkerHighlight(b)}else{b.setStyle(b.options.previousOptions);delete b.options.previousOptions}}if(b instanceof a.Marker){b.dragging.disable();b.off("dragend",this._onMarkerDragEnd,this).off("touchmove",this._onTouchMove,this).off("MSPointerMove",this._onTouchMove,this).off("touchend",this._onMarkerDragEnd,this).off("MSPointerUp",this._onMarkerDragEnd,this)}else{b.editing.disable()}},_onMouseMove:function(b){this._tooltip.updatePosition(b.latlng)},_onTouchMove:function(d){var b=d.originalEvent.changedTouches[0],c=this._map.mouseEventToLayerPoint(b),f=this._map.layerPointToLatLng(c);d.target.setLatLng(f)},_hasAvailableLayers:function(){return this._featureGroup.getLayers().length!==0}});a.EditTool.Delete=a.Handler.extend({statics:{TYPE:"remove"},includes:a.Mixin.Events,initialize:function(c,b){a.Handler.prototype.initialize.call(this,c);a.Util.setOptions(this,b);this._deletableLayers=this.options.featureGroup;if(!(this._deletableLayers instanceof a.FeatureGroup)){throw new Error("options.featureGroup must be a L.FeatureGroup")}this.type=a.EditTool.Delete.TYPE},enable:function(){if(this._enabled||!this._hasAvailableLayers()){return}this.fire("enabled",{handler:this.type});this._map.fire("draw:deletestart",{handler:this.type});a.Handler.prototype.enable.call(this);this._deletableLayers.on("layeradd",this._enableLayerDelete,this).on("layerremove",this._disableLayerDelete,this)},disable:function(){if(!this._enabled){return}this._deletableLayers.off("layeradd",this._enableLayerDelete,this).off("layerremove",this._disableLayerDelete,this);a.Handler.prototype.disable.call(this);this._map.fire("draw:deletestop",{handler:this.type});this.fire("disabled",{handler:this.type})},addHooks:function(){var b=this._map;if(b){b.getContainer().focus();this._deletableLayers.eachLayer(this._enableLayerDelete,this);this._deletedLayers=new a.LayerGroup();this._tooltip=new a.Drawtip(this._map);this._tooltip.updateContent({text:a.drawLocal.edit.handlers.remove.tooltip.text});this._map.on("mousemove",this._onMouseMove,this)}},removeHooks:function(){if(this._map){this._deletableLayers.eachLayer(this._disableLayerDelete,this);this._deletedLayers=null;this._tooltip.dispose();this._tooltip=null;this._map.off("mousemove",this._onMouseMove,this)}},revertLayers:function(){this._deletedLayers.eachLayer(function(b){this._deletableLayers.addLayer(b);b.fire("revert-deleted",{layer:b})},this)},save:function(){this._map.fire("draw:deleted",{layers:this._deletedLayers})},_enableLayerDelete:function(c){var b=c.layer||c.target||c;b.on("click",this._removeLayer,this)},_disableLayerDelete:function(c){var b=c.layer||c.target||c;b.off("click",this._removeLayer,this);this._deletedLayers.removeLayer(b)},_removeLayer:function(c){var b=c.layer||c.target||c;this._deletableLayers.removeLayer(b);this._deletedLayers.addLayer(b);b.fire("deleted")},_onMouseMove:function(b){this._tooltip.updatePosition(b.latlng)},_hasAvailableLayers:function(){return this._deletableLayers.getLayers().length!==0}});a.Measure=a.Measure||{};a.Measure.Path=a.Draw.Polyline.extend({initialize:function(c,b){a.Draw.Polyline.prototype.initialize.call(this,c,b);this._cache=[]},addHooks:function(){a.Draw.Polyline.prototype.addHooks.call(this);if(this._map){this._markerGroup=new a.LayerGroup();this._map.addLayer(this._markerGroup);this._markers=[];this._popups=[];this._map.on("click",this._onClick,this);this._startShape()}},removeHooks:function(){this._clearHideErrorTimeout();this._mouseMarker.off("mousedown",this._onMouseDown,this).off("mouseout",this._onMouseOut,this).off("mouseup",this._onMouseUp,this).off("mousemove",this._onMouseMove,this);this._map.removeLayer(this._mouseMarker);delete this._mouseMarker;this._map.off("pointermove",this._onMouseMove,this).off("mousemove",this._onMouseMove,this).off("click",this._onClick,this);this._clearGuides();this._container.style.cursor="";this._tooltip.dispose()},_startShape:function(){this._drawing=true;this._poly=new a.Polyline([],this.options.shapeOptions);this._poly._onClick=function(){};this._container.style.cursor="crosshair";this._updateTooltip();this._map.on("pointermove",this._onMouseMove,this).on("mousemove",this._onMouseMove,this)},_finishShape:function(){this._drawing=false;this._cleanUpShape();this._clearGuides();this._updateTooltip();this._map.off("pointermove",this._onMouseMove,this).off("mousemove",this._onMouseMove,this);this._container.style.cursor="";this.disable();var d=a.stamp(this._poly);var e="measure-"+d;var c={id:e,popups:this._popups,markers:this._markers,poly:this._poly};this._cache.push(c);if(this._tippopup){var f=this._tippopup.getContent();var g=a.DomUtil.create("div","leaflet-measure-tipclose");g.id=e;g.title="清除本次测距";this._tippopup._contentNode.appendChild(g);var b=this._tippopup._contentNode.offsetWidth;this._tippopup._contentNode.style.width=(b+30)+"px";a.DomEvent.on(g,"click",this._onTipClose,this)}},_removeShape:function(){if(!this._poly){return}this._map.removeLayer(this._poly);delete this._poly;this._markers.splice(0);this._markerGroup.clearLayers()},_onClick:function(){if(!this._drawing){this._removeShape();this._startShape();return}},_getTooltipText:function(){var b=a.Draw.Polyline.prototype._getTooltipText.call(this);if(!this._drawing){b.text=""}return b},addVertex:function(h){var e=this._markers.length;if(e>0&&!this.options.allowIntersection&&this._poly.newLatLngIntersects(h)){this._showErrorTooltip();return}else{if(this._errorShown){this._hideErrorTooltip()}}var d=this._createMarker(h);a.DomEvent.on(d,"dblclick",this._preventMouseEvent,this);var g=this._getTooltipText();var f="";var c;if(g.subtext){f=g.subtext;c=46}else{f="起点";c=40}var b=new a.TipPopup({offset:new a.Point(c,24)});b.setLatLng(h).setContent(f).openOn(this._map);b._sort="tip-popup";this._tippopup=b;this._popups.push(b);this._markers.push(d);this._poly.addLatLng(h);if(this._poly.getLatLngs().length===2){this._map.addLayer(this._poly)}this._vertexChanged(h,true)},_onTipClose:function(j){var g=j.target||j.srcElement;var f=g.id;var b=this._getCacheById(f);if(b){var c=b.popups;var k=b.markers;var h=b.poly;this._map.removeLayer(h);for(var d=0;d<k.length;d++){if(k[d]&&c[d]){this._map.removeLayer(k[d]);this._map.removeLayer(c[d])}}this._deleteCacheById(f)}},_getCacheById:function(d){var b;for(var c=0;c<this._cache.length;c++){if(this._cache[c].id==d){b=this._cache[c];break}}return b},_deleteCacheById:function(c){for(var b=this._cache.length-1;b>=0;b--){if(this._cache[b].id==c){this._cache.splice(b,1);break}}},_preventMouseEvent:function(b){if(b.type==="contextmenu"&&this.hasEventListeners(b.type)){a.DomEvent.preventDefault(b)}if(b.type!=="mousedown"){a.DomEvent.stopPropagation(b)}else{a.DomEvent.preventDefault(b)}},clear:function(){var b=this._cache;for(var d=0;d<b.length;d++){var c=b[d];var e=c.popups;var h=c.markers;var g=c.poly;this._map.removeLayer(g);for(var f=0;f<h.length;f++){if(h[f]&&e[f]){this._map.removeLayer(h[f]);this._map.removeLayer(e[f])}}}this._popups=[];this._markers=[];this._poly=null;this._cache=[]}});a.Measure=a.Measure||{};a.Measure.Area=a.Draw.Polygon.extend({options:{showArea:true,shapeOptions:{stroke:true,color:"#f06eaa",weight:4,opacity:0.5,fill:true,fillColor:null,fillOpacity:0.2,clickable:true},metric:true},initialize:function(c,b){a.Draw.Polygon.prototype.initialize.call(this,c,b);this._cache=[]},addHooks:function(){a.Draw.Polygon.prototype.addHooks.call(this);if(this._map&&!this._areaGroup){this._areaGroup=new a.LayerGroup();this._map.addLayer(this._areaGroup)}},removeHooks:function(){this._clearHideErrorTimeout();this._cleanUpShape();this._map.removeLayer(this._markerGroup);delete this._markerGroup;delete this._markers;this._map.removeLayer(this._poly);delete this._poly;this._mouseMarker.off("mousedown",this._onMouseDown,this).off("mouseout",this._onMouseOut,this).off("mouseup",this._onMouseUp,this).off("mousemove",this._onMouseMove,this);this._map.removeLayer(this._mouseMarker);delete this._mouseMarker;this._clearGuides();this._map.off("mouseup",this._onMouseUp,this).off("mousemove",this._onMouseMove,this).off("zoomlevelschange",this._onZoomEnd,this).off("zoomend",this._onZoomEnd,this).off("click",this._onTouch,this);this._container.style.cursor="";this._tooltip.dispose()},_finishShape:function(){this._cleanUpShape();this._clearGuides();var c=this._poly.getLatLngs();var m=c[c.length-1];var i=this._poly.newLatLngIntersects(m);if((!this.options.allowIntersection&&i)||!this._shapeIsValid()){this._showErrorTooltip();return}var g=a.GeometryUtil.geodesicArea(c);g=a.GeometryUtil.readableArea(g,this.options.metric);var d=new this.Poly(this._poly.getLatLngs(),this.options.shapeOptions);this._areaGroup.addLayer(d);var e=a.stamp(d);var h="measure-"+e;var f=new a.TipPopup({offset:new a.Point(36,-4)});f.setLatLng(m).setContent(g).openOn(this._map);f._sort="tip-popup";var j=f.getContent();var k=a.DomUtil.create("div","leaflet-measure-tipclose");k.id=h;k.title="清除本次测面";f._contentNode.appendChild(k);var l=f._contentNode.offsetWidth;f._contentNode.style.width=(l+30)+"px";a.DomEvent.on(k,"click",this._onTipClose,this);var b={id:h,popup:f,poly:d};this._cache.push(b);this.disable()},_onTipClose:function(h){var f=h.target||h.srcElement;var d=f.id;var c=this._getCacheById(d);if(c){var b=c.popup;var g=c.poly;this._map.removeLayer(g);this._map.removeLayer(b);this._deleteCacheById(d)}},_getCacheById:function(d){var b;for(var c=0;c<this._cache.length;c++){if(this._cache[c].id==d){b=this._cache[c];break}}return b},_deleteCacheById:function(c){for(var b=this._cache.length-1;b>=0;b--){if(this._cache[b].id==c){this._cache.splice(b,1);break}}},clear:function(){var c=this._cache;for(var e=0;e<c.length;e++){var d=c[e];var b=d.popup;var f=d.poly;this._map.removeLayer(f);this._map.removeLayer(b)}this._cache=[]}});a.Knob=a.Draggable.extend({initialize:function(c,d,b){a.Draggable.prototype.initialize.call(this,c,c);this._element=c;this._stepHeight=d;this._knobHeight=b;this.on("predrag",function(){this._newPos.x=0;this._newPos.y=this._adjust(this._newPos.y)},this)},_adjust:function(c){var b=Math.round(this._toValue(c));b=Math.max(0,Math.min(this._maxValue,b));return this._toY(b)},_toY:function(b){return this._k*b+this._m},_toValue:function(b){return(b-this._m)/this._k},setSteps:function(b){var c=b*this._stepHeight;this._maxValue=b-1;this._k=-this._stepHeight;this._m=c-(this._stepHeight+this._knobHeight)/2},setPosition:function(b){a.DomUtil.setPosition(this._element,a.point(0,this._adjust(b)))},setValue:function(b){this.setPosition(this._toY(b))},getValue:function(){return this._toValue(a.DomUtil.getPosition(this._element).y)}});a.Control.Zoomslider=a.Control.extend({options:{position:"topleft",stepHeight:8,knobHeight:6,styleNS:"leaflet-control-zoomslider"},onAdd:function(b){this._map=b;this._ui=this._createUI();this._knob=new a.Knob(this._ui.knob,this.options.stepHeight,this.options.knobHeight);b.whenReady(this._initKnob,this).whenReady(this._initEvents,this).whenReady(this._updateSize,this).whenReady(this._updateKnobValue,this).whenReady(this._updateDisabled,this);return this._ui.bar},onRemove:function(b){b.off("zoomlevelschange",this._updateSize,this).off("zoomend zoomlevelschange",this._updateKnobValue,this).off("zoomend zoomlevelschange",this._updateDisabled,this)},_createUI:function(){var c={},b=this.options.styleNS;c.bar=a.DomUtil.create("div",b+" leaflet-bar");c.zoomIn=this._createZoomBtn("in","top",c.bar);c.wrap=a.DomUtil.create("div",b+"-wrap leaflet-bar-part",c.bar);c.zoomOut=this._createZoomBtn("out","bottom",c.bar);c.body=a.DomUtil.create("div",b+"-body",c.wrap);c.knob=a.DomUtil.create("div",b+"-knob");a.DomEvent.disableClickPropagation(c.bar);a.DomEvent.disableClickPropagation(c.knob);return c},_createZoomBtn:function(d,c,b){var e=this.options.styleNS+"-"+d+" leaflet-bar-part leaflet-bar-part-"+c,f=a.DomUtil.create("a",e,b);f.href="#";if(d=="in"){f.title="放大一级"}else{f.title="缩小一级"}a.DomEvent.on(f,"click",a.DomEvent.preventDefault);return f},_initKnob:function(){this._knob.enable();this._ui.body.appendChild(this._ui.knob)},_initEvents:function(){this._map.on("zoomlevelschange",this._updateSize,this).on("zoomend zoomlevelschange",this._updateKnobValue,this).on("zoomend zoomlevelschange",this._updateDisabled,this);a.DomEvent.on(this._ui.body,"click",this._onSliderClick,this);a.DomEvent.on(this._ui.zoomIn,"click",this._zoomIn,this);a.DomEvent.on(this._ui.zoomOut,"click",this._zoomOut,this);this._knob.on("dragend",this._updateMapZoom,this)},_onSliderClick:function(b){var c=(b.touches&&b.touches.length===1?b.touches[0]:b),d=a.DomEvent.getMousePosition(c,this._ui.body).y;this._knob.setPosition(d);this._updateMapZoom()},_zoomIn:function(b){this._map.zoomIn(b.shiftKey?3:1)},_zoomOut:function(b){this._map.zoomOut(b.shiftKey?3:1)},_zoomLevels:function(){var b=this._map.getMaxZoom()-this._map.getMinZoom()+1;return b<Infinity?b:0},_toZoomLevel:function(b){return b+this._map.getMinZoom()},_toValue:function(b){return b-this._map.getMinZoom()},_updateSize:function(){var b=this._zoomLevels();this._ui.body.style.height=this.options.stepHeight*b+"px";this._knob.setSteps(b)},_updateMapZoom:function(){this._map.setZoom(this._toZoomLevel(this._knob.getValue()))},_updateKnobValue:function(){this._knob.setValue(this._toValue(this._map.getZoom()))},_updateDisabled:function(){var c=this._map.getZoom(),b=this.options.styleNS+"-disabled";a.DomUtil.removeClass(this._ui.zoomIn,b);a.DomUtil.removeClass(this._ui.zoomOut,b);if(c===this._map.getMinZoom()){a.DomUtil.addClass(this._ui.zoomOut,b)}if(c===this._map.getMaxZoom()){a.DomUtil.addClass(this._ui.zoomIn,b)}}});a.control.zoomslider=function(b){return new a.Control.Zoomslider(b)};a.Control.MousePosition=a.Control.extend({options:{position:"bottomleft",separator:" : ",emptyString:"Unavailable",lngFirst:true,numDigits:5,lngFormatter:undefined,latFormatter:undefined,prefix:""},onAdd:function(b){this._container=a.DomUtil.create("div","leaflet-control-mouseposition");a.DomEvent.disableClickPropagation(this._container);b.on("mousemove",this._onMouseMove,this);this._container.innerHTML=this.options.emptyString;return this._container},onRemove:function(b){b.off("mousemove",this._onMouseMove)},_onMouseMove:function(g){var c=this.options.lngFormatter?this.options.lngFormatter(g.latlng.lng):a.Util.formatNum(g.latlng.lng,this.options.numDigits);var f=this.options.latFormatter?this.options.latFormatter(g.latlng.lat):a.Util.formatNum(g.latlng.lat,this.options.numDigits);var d=this.options.lngFirst?c+this.options.separator+f:f+this.options.separator+c;var b=this.options.prefix+" "+d;this._container.innerHTML=b}});a.Map.mergeOptions({positionControl:false});a.Map.addInitHook(function(){if(this.options.positionControl){this.positionControl=new a.Control.MousePosition();this.addControl(this.positionControl)}});a.control.mousePosition=function(b){return new a.Control.MousePosition(b)};a.TileLayer.WMTS=a.TileLayer.extend({defaultWmtsParams:{service:"WMTS",request:"GetTile",version:"1.0.0",layer:"",style:"",tilematrixSet:"",format:"image/jpeg"},initialize:function(c,b){this._url=c;var e=a.extend({},this.defaultWmtsParams),f=b.tileSize||this.options.tileSize;if(b.detectRetina&&a.Browser.retina){e.width=e.height=f*2}else{e.width=e.height=f}for(var d in b){if(!this.options.hasOwnProperty(d)&&d!="matrixIds"){e[d]=b[d]}}this.wmtsParams=e;this.matrixIds=b.matrixIds||this.getDefaultMatrix();a.setOptions(this,b)},onAdd:function(b){a.TileLayer.prototype.onAdd.call(this,b)},getTileUrl:function(c){var q=this._map;var d=q.options.crs;var k=this.options.tileSize;var j=c.multiplyBy(k);j.x+=1;j.y-=1;var i=j.add(new a.Point(k,k));var o=d.project(q.unproject(j));var s=d.project(q.unproject(i));var n=s.x-o.x;var b=this._getZoomForUrl();var r=q.getScales()[b];var m=this.getMatrixIdByScale(r);var l=m.identifier;var p=m.topLeftCorner.lng;var f=m.topLeftCorner.lat;var g=Math.round((o.x-p)/n);var h=-Math.round((o.y-f)/n);var e=a.Util.template(this._url,{s:this._getSubdomain(c)});return e+a.Util.getParamString(this.wmtsParams,e)+"&tilematrix="+l+"&tilerow="+h+"&tilecol="+g},setParams:function(c,b){a.extend(this.wmtsParams,c);if(!b){this.redraw()}return this},getDefaultMatrix:function(){var c=new Array(22);for(var b=0;b<22;b++){c[b]={identifier:""+b,topLeftCorner:new a.LatLng(20037508.3428,-20037508.3428)}}return c},getMatrixIdByScale:function(f){var c;for(var d=0;d<this.matrixIds.length;d++){var b=this.matrixIds[d].scaleDenominator;var e=parseFloat(b)/parseFloat(f);if(e>0.9&&e<1.1){c=this.matrixIds[d];break}}return c}});a.tileLayer.wmts=function(c,b){return new a.TileLayer.WMTS(c,b)};a.TileLayer.ImeDynamicMapService=a.TileLayer.extend({params:{FORMAT:"png",TRANSPARENT:true},options:{tileSize:256,layers:false,FORMAT:"png",TRANSPARENT:true},initialize:function(c,b){this._url=c+"/export";b=a.setOptions(this,b);b.width=b.height=b.tileSize*(b.detectRetina&&a.Browser.retina?2:1);this.mapService=new a.ImeMapService({url:c})},onAdd:function(b){this._crs=b.options.crs;a.TileLayer.prototype.onAdd.call(this,b)},getTileUrl:function(d){var e=this._tileCoordsToBounds(d),b=this._crs.project(e.getNorthWest()),c=this._crs.project(e.getSouthEast());var f={TRANSPARENT:this.options.TRANSPARENT,FORMAT:this.options.FORMAT,xmin:b.x,ymin:c.y,xmax:c.x,ymax:b.y,width:this.options.width,height:this.options.height};if(this.options.layers){f.layers=this.options.layers.join(",")}a.extend(this.params,f);url=a.TileLayer.prototype.getTileUrl.call(this,d);return url+a.Util.getParamString(this.params,url)},setParams:function(c,b){a.extend(this.params,c);if(!b){this.redraw()}return this},setLayers:function(c,b){this.options.layers=c;if(!b){this.redraw()}}});a.imeDynamicMapService=function(c,b){return new a.TileLayer.ImeDynamicMapService(c,b)};a.BaseImageLayer=a.Layer.extend({includes:a.Mixin.Events,options:{opacity:1,position:"front",f:"image"},onAdd:function(c){this._map=c;this._update=this.limitExecByInterval(this._update,this.options.updateInterval,this);if(c.options.crs&&c.options.crs.code){var b=c.options.crs.code.split(":")[1]}c.on("moveend",this._update,this);if(this._currentImage&&this._currentImage._bounds.equals(this._map.getBounds())){c.addLayer(this._currentImage)}else{if(this._currentImage){this._map.removeLayer(this._currentImage);this._currentImage=null}}this._update()},onRemove:function(b){if(this._currentImage){this._map.removeLayer(this._currentImage)}this._map.off("moveend",this._update,this);this._map=null},bringToFront:function(){this.options.position="front";if(this._currentImage){this._currentImage.bringToFront()}return this},bringToBack:function(){this.options.position="back";if(this._currentImage){this._currentImage.bringToBack()}return this},getAttribution:function(){return this.options.attribution},getOpacity:function(){return this.options.opacity},setOpacity:function(b){this.options.opacity=b;this._currentImage.setOpacity(b);return this},_renderImage:function(b,c){if(this._map){var d=new a.ImageOverlay(b,c,{opacity:0}).addTo(this._map);d.once("load",function(g){var h=g.target;var f=this._currentImage;if(h._bounds.equals(c)&&h._bounds.equals(this._map.getBounds())){this._currentImage=h;if(this.options.position==="front"){this.bringToFront()}else{this.bringToBack()}if(this._map&&this._currentImage._map){this._currentImage.setOpacity(this.options.opacity)}else{this._currentImage._map.removeLayer(this._currentImage)}if(f&&this._map){this._map.removeLayer(f)}if(f&&f._map){f._map.removeLayer(f)}}else{this._map.removeLayer(h)}this.fire("load",{bounds:c})},this);this.fire("loading",{bounds:c})}},_update:function(){if(!this._map){return}var c=this._map.getZoom();var b=this._map.getBounds();if(this._animatingZoom){return}if(this._map._panTransition&&this._map._panTransition._inProgress){return}if(c>this.options.maxZoom||c<this.options.minZoom){if(this._currentImage){this._currentImage._map.removeLayer(this._currentImage)}return}var d=this._buildExportParams();this._requestExport(d,b)},limitExecByInterval:function(e,g,d){var c,f;return function b(){var h=arguments;if(c){f=true;return}c=true;setTimeout(function(){c=false;if(f){b.apply(d,h);f=false}},g);e.apply(d,h)}}});a.BaseImageLayer.ImeDynamicMapService=a.BaseImageLayer.extend({options:{updateInterval:150,layers:false,format:"png",transparent:true},initialize:function(b){a.Util.setOptions(this,b);this.mapService=new a.ImeMapService({url:b.url})},getLayers:function(){return this.options.layers},setLayers:function(b){this.options.layers=b;this._update();return this},clearLayers:function(){delete this.options.layers;this._update()},setFilter:function(c,b){this.options.filter=b;this.options.layerid=c;this._setFilterOrRender(c)},setRender:function(c,b){this.options.render=b;this.options.layerid=c;this._setFilterOrRender(c)},clearFilter:function(){if(this.options.layerid){delete this.options.filter;this._setFilterOrRender(this.options.layerid)}},clearRender:function(){if(this.options.layerid){delete this.options.render;this._setFilterOrRender(this.options.layerid)}},clearLayersRender:function(){delete this.options.layerid;delete this.options.filter;delete this.options.render;delete this.options.layersRender;this._update()},_setFilterOrRender:function(j){var f=["layerid","filter","render"];var h={layerid:j};if(!this.options.filter&&!this.options.render){this.clearLayersRender();return false}if(this.options.filter){h.filter=this.options.filter}if(this.options.render){h.render=this.options.render}var b=[];for(var e=0;e<f.length;e++){var d=f[e];if(d in h){var g="";if(d=="render"){if(typeof(h[d])=="string"){g+='"'+d+'":'+h[d]}else{g+='"'+d+'":'+JSON.stringify(h[d])}}else{g+='"'+d+'":"'+h[d]+'"'}b.push(g)}}var c="{"+b.join(",")+"}";this.options.layersRender=c;this._update();return this},_buildExportParams:function(){var e=this._map.getBounds();var d=this._map.getSize();var g=this._map.options.crs.project(e._northEast);var b=this._map.options.crs.project(e._southWest);var f=this._map.latLngToLayerPoint(e._northEast);var c=this._map.latLngToLayerPoint(e._southWest);if(f.y>0||c.y<d.y){d.y=c.y-f.y}var h={xmin:b.x,ymin:b.y,xmax:g.x,ymax:g.y,width:d.x,height:d.y,format:this.options.format,transparent:this.options.transparent};if(this.options.layers){h.layers=this.options.layers.join(",")}if(this.options.layersRender){h.layersRender=this.options.layersRender}this.params=h;return h},_requestExport:function(c,b){this._renderImage(this.options.url+"/export"+a.Util.getParamString(c),b)}});a.BaseImageLayer.imeDynamicMapService=function(b){return new a.BaseImageLayer.ImeDynamicMapService(b)};a.Format=a.Class.extend({options:null,initialize:function(b){this.options=a.setOptions(this,b)},destroy:function(){},read:function(b){},write:function(b){}});a.Format.XML=a.Format.extend({namespaces:null,namespaceAlias:null,defaultPrefix:null,readers:{},writers:{},xmldom:null,initialize:function(b){if(window.ActiveXObject){this.xmldom=new ActiveXObject("Microsoft.XMLDOM")}a.Format.prototype.initialize.apply(this,[b]);this.namespaces=a.extend({},this.namespaces);this.namespaceAlias={};for(var c in this.namespaces){this.namespaceAlias[this.namespaces[c]]=c}},destroy:function(){this.xmldom=null;a.Format.prototype.destroy.apply(this,arguments)},setNamespace:function(b,c){this.namespaces[b]=c;this.namespaceAlias[c]=b},read:function(d){var b=d.indexOf("<");if(b>0){d=d.substring(b)}var c=a.FormatUtil.tryFunc(a.FormatUtil.bind((function(){var e;if(window.ActiveXObject&&!this.xmldom){e=new ActiveXObject("Microsoft.XMLDOM")}else{e=this.xmldom}e.loadXML(d);return e}),this),function(){return new DOMParser().parseFromString(d,"text/xml")},function(){var e=new XMLHttpRequest();e.open("GET","data:text/xml;charset=utf-8,"+encodeURIComponent(d),false);if(e.overrideMimeType){e.overrideMimeType("text/xml")}e.send(null);return e.responseXML});return c},write:function(c){var d;if(this.xmldom){d=c.xml}else{var b=new XMLSerializer();if(c.nodeType==1){var e=document.implementation.createDocument("","",null);if(e.importNode){c=e.importNode(c,true)}e.appendChild(c);d=b.serializeToString(e)}else{d=b.serializeToString(c)}}return d},createElementNS:function(d,b){var c;if(this.xmldom){if(typeof d=="string"){c=this.xmldom.createNode(1,b,d)}else{c=this.xmldom.createNode(1,b,"")}}else{c=document.createElementNS(d,b)}return c},createDocumentFragment:function(){var b;if(this.xmldom){b=this.xmldom.createDocumentFragment()}else{b=document.createDocumentFragment()}return b},createTextNode:function(c){var b;if(typeof c!=="string"){c=String(c)}if(this.xmldom){b=this.xmldom.createTextNode(c)}else{b=document.createTextNode(c)}return b},getElementsByTagNameNS:function(f,e,d){var b=[];if(f.getElementsByTagNameNS){b=f.getElementsByTagNameNS(e,d)}else{var c=f.getElementsByTagName("*");var k,g;for(var h=0,j=c.length;h<j;++h){k=c[h];g=(k.prefix)?(k.prefix+":"+d):d;if((d=="*")||(g==k.nodeName)){if((e=="*")||(e==k.namespaceURI)){b.push(k)}}}}return b},getAttributeNodeNS:function(d,c,b){var k=null;if(d.getAttributeNodeNS){k=d.getAttributeNodeNS(c,b)}else{var f=d.attributes;var j,e;for(var g=0,h=f.length;g<h;++g){j=f[g];if(j.namespaceURI==c){e=(j.prefix)?(j.prefix+":"+b):b;if(e==j.nodeName){k=j;break}}}}return k},getAttributeNS:function(f,e,b){var c="";if(f.getAttributeNS){c=f.getAttributeNS(e,b)||""}else{var d=this.getAttributeNodeNS(f,e,b);if(d){c=d.nodeValue}}return c},getChildValue:function(b,d){var c=d||"";if(b){for(var e=b.firstChild;e;e=e.nextSibling){switch(e.nodeType){case 3:case 4:c+=e.nodeValue}}}return c},isSimpleContent:function(b){var d=true;for(var c=b.firstChild;c;c=c.nextSibling){if(c.nodeType===1){d=false;break}}return d},hasAttributeNS:function(d,c,b){var e=false;if(d.hasAttributeNS){e=d.hasAttributeNS(c,b)}else{e=!!this.getAttributeNodeNS(d,c,b)}return e},setAttributeNS:function(e,d,b,f){if(e.setAttributeNS){e.setAttributeNS(d,b,f)}else{if(this.xmldom){if(d){var c=e.ownerDocument.createNode(2,b,d);c.nodeValue=f;e.setAttributeNode(c)}else{e.setAttribute(b,f)}}else{throw"setAttributeNS not implemented"}}},createElementNSPlus:function(c,b){b=b||{};var e=b.uri||this.namespaces[b.prefix];if(!e){var g=c.indexOf(":");e=this.namespaces[c.substring(0,g)]}if(!e){e=this.namespaces[this.defaultPrefix]}var d=this.createElementNS(e,c);if(b.attributes){this.setAttributes(d,b.attributes)}var f=b.value;if(f!=null){d.appendChild(this.createTextNode(f))}return d},setAttributes:function(d,f){var e,c;for(var b in f){if(f[b]!=null&&f[b].toString){e=f[b].toString();c=this.namespaces[b.substring(0,b.indexOf(":"))]||null;this.setAttributeNS(d,c,b,e)}}},readNode:function(d,f){if(!f){f={}}var e=this.readers[d.namespaceURI?this.namespaceAlias[d.namespaceURI]:this.defaultPrefix];if(e){var c=d.localName||d.nodeName.split(":").pop();var b=e[c]||e["*"];if(b){b.apply(this,[d,f])}}return f},readChildNodes:function(e,f){if(!f){f={}}var d=e.childNodes;var g;for(var c=0,b=d.length;c<b;++c){g=d[c];if(g.nodeType==1){this.readNode(g,f)}}return f},writeNode:function(b,g,e){var f,d;var c=b.indexOf(":");if(c>0){f=b.substring(0,c);d=b.substring(c+1)}else{if(e){f=this.namespaceAlias[e.namespaceURI]}else{f=this.defaultPrefix}d=b}var h=this.writers[f][d].apply(this,[g]);if(e){e.appendChild(h)}return h},getChildEl:function(d,b,c){return d&&this.getThisOrNextEl(d.firstChild,b,c)},getNextEl:function(d,b,c){return d&&this.getThisOrNextEl(d.nextSibling,b,c)},getThisOrNextEl:function(e,b,d){outer:for(var c=e;c;c=c.nextSibling){switch(c.nodeType){case 1:if((!b||b===(c.localName||c.nodeName.split(":").pop()))&&(!d||d===c.namespaceURI)){break outer}c=null;break outer;case 3:if(/^\s*$/.test(c.nodeValue)){break}case 4:case 6:case 12:case 10:case 11:c=null;break outer}}return c||null},lookupNamespaceURI:function(f,g){var e=null;if(f){if(f.lookupNamespaceURI){e=f.lookupNamespaceURI(g)}else{outer:switch(f.nodeType){case 1:if(f.namespaceURI!==null&&f.prefix===g){e=f.namespaceURI;break outer}var c=f.attributes.length;if(c){var b;for(var d=0;d<c;++d){b=f.attributes[d];if(b.prefix==="xmlns"&&b.name==="xmlns:"+g){e=b.value||null;break outer}else{if(b.name==="xmlns"&&g===null){e=b.value||null;break outer}}}}e=this.lookupNamespaceURI(f.parentNode,g);break outer;case 2:e=this.lookupNamespaceURI(f.ownerElement,g);break outer;case 9:e=this.lookupNamespaceURI(f.documentElement,g);break outer;case 6:case 12:case 10:case 11:break outer;default:e=this.lookupNamespaceURI(f.parentNode,g);break outer}}}return e},getXMLDoc:function(){if(!a.Format.XML.document&&!this.xmldom){if(document.implementation&&document.implementation.createDocument){a.Format.XML.document=document.implementation.createDocument("","",null)}else{if(!this.xmldom&&window.ActiveXObject){this.xmldom=new ActiveXObject("Microsoft.XMLDOM")}}}return a.Format.XML.document||this.xmldom},});a.Format.XML.document=null;a.Format.XML.VersionedOGC=a.Format.XML.extend({defaultVersion:null,version:null,profile:null,allowFallback:false,name:null,stringifyOutput:false,parser:null,initialize:function(b){a.Format.XML.prototype.initialize.apply(this,[b])},getVersion:function(c,d){var b;if(c){b=this.version;if(!b){b=c.getAttribute("version");if(!b){b=this.defaultVersion}}}else{b=(d&&d.version)||this.version||this.defaultVersion}return b},getParser:function(b){b=b||this.defaultVersion;var c=this.profile?"_"+this.profile:"";if(!this.parser||this.parser.VERSION!=b){var d=a.Format[this.name]["v"+b.replace(/\./g,"_")+c];if(d){this.parser=new d(this.options)}}return this.parser},write:function(e,d){var c=this.getVersion(null,d);this.parser=this.getParser(c);var b=this.parser.write(e,d);if(this.stringifyOutput===false){return b}else{return a.Format.XML.prototype.write.apply(this,[b])}},read:function(e,d){if(typeof e=="string"){e=a.Format.XML.prototype.read.apply(this,[e])}var c=e.documentElement;var b=this.getVersion(c);this.parser=this.getParser(b);var f=this.parser.read(e,d);f.version=b;return f}});a.Format.OWSCommon=a.Format.XML.VersionedOGC.extend({defaultVersion:"1.0.0",getVersion:function(c,d){var b=this.version;if(!b){var e=c.getAttribute("xmlns:ows");if(e&&e.substring(e.lastIndexOf("/")+1)==="1.1"){b="1.1.0"}if(!b){b=this.defaultVersion}}return b}});a.Format.WMTSCapabilities=a.Format.XML.VersionedOGC.extend({name:"WMTSCapabilities",defaultVersion:"1.0.0",yx:{"urn:ogc:def:crs:EPSG::4326":true,"urn:ogc:def:crs:EPSG::4490":true,"urn:ogc:def:crs:EPSG::900913":true},xy:{"urn:ogc:def:crs:EPSG::3857":true,"urn:ogc:def:crs:EPSG::3785":true,"urn:ogc:def:crs:EPSG::102100":true}});a.Format.OWSCommon.v1=a.Format.XML.extend({regExes:{trimSpace:(/^\s*|\s*$/g),removeSpace:(/\s*/g),splitSpace:(/\s+/),trimComma:(/\s*,\s*/g)},read:function(c,b){b=a.FormatUtil.applyDefaults(b,this.options);var d={};this.readChildNodes(c,d);return d},readers:{ows:{Exception:function(c,d){var b={code:c.getAttribute("exceptionCode"),locator:c.getAttribute("locator"),texts:[]};d.exceptions.push(b);this.readChildNodes(c,b)},ExceptionText:function(c,b){var d=this.getChildValue(c);b.texts.push(d)},ServiceIdentification:function(b,c){c.serviceIdentification={};this.readChildNodes(b,c.serviceIdentification)},Title:function(b,c){c.title=this.getChildValue(b)},Abstract:function(b,c){c["abstract"]=this.getChildValue(b)},Keywords:function(b,c){c.keywords={};this.readChildNodes(b,c.keywords)},Keyword:function(c,b){b[this.getChildValue(c)]=true},ServiceType:function(b,c){c.serviceType={codeSpace:b.getAttribute("codeSpace"),value:this.getChildValue(b)}},ServiceTypeVersion:function(b,c){c.serviceTypeVersion=this.getChildValue(b)},Fees:function(b,c){c.fees=this.getChildValue(b)},AccessConstraints:function(b,c){c.accessConstraints=this.getChildValue(b)},ServiceProvider:function(b,c){c.serviceProvider={};this.readChildNodes(b,c.serviceProvider)},ProviderName:function(b,c){c.providerName=this.getChildValue(b)},ProviderSite:function(b,c){c.providerSite=this.getAttributeNS(b,this.namespaces.xlink,"href")},ServiceContact:function(b,c){c.serviceContact={};this.readChildNodes(b,c.serviceContact)},IndividualName:function(c,b){b.individualName=this.getChildValue(c)},PositionName:function(c,b){b.positionName=this.getChildValue(c)},ContactInfo:function(c,b){b.contactInfo={};this.readChildNodes(c,b.contactInfo)},Phone:function(c,b){b.phone={};this.readChildNodes(c,b.phone)},Voice:function(c,b){b.voice=this.getChildValue(c)},Address:function(c,b){b.address={};this.readChildNodes(c,b.address)},DeliveryPoint:function(c,b){b.deliveryPoint=this.getChildValue(c)},City:function(c,b){b.city=this.getChildValue(c)},AdministrativeArea:function(c,b){b.administrativeArea=this.getChildValue(c)},PostalCode:function(c,b){b.postalCode=this.getChildValue(c)},Country:function(c,b){b.country=this.getChildValue(c)},ElectronicMailAddress:function(c,b){b.electronicMailAddress=this.getChildValue(c)},Role:function(c,b){b.role=this.getChildValue(c)},OperationsMetadata:function(b,c){c.operationsMetadata={};this.readChildNodes(b,c.operationsMetadata)},Operation:function(d,c){var b=d.getAttribute("name");c[b]={};this.readChildNodes(d,c[b])},DCP:function(c,b){b.dcp={};this.readChildNodes(c,b.dcp)},HTTP:function(c,b){b.http={};this.readChildNodes(c,b.http)},Get:function(c,b){if(!b.get){b.get=[]}var d={url:this.getAttributeNS(c,this.namespaces.xlink,"href")};this.readChildNodes(c,d);b.get.push(d)},Post:function(c,b){if(!b.post){b.post=[]}var d={url:this.getAttributeNS(c,this.namespaces.xlink,"href")};this.readChildNodes(c,d);b.post.push(d)},Parameter:function(d,b){if(!b.parameters){b.parameters={}}var c=d.getAttribute("name");b.parameters[c]={};this.readChildNodes(d,b.parameters[c])},Constraint:function(c,d){if(!d.constraints){d.constraints={}}var b=c.getAttribute("name");d.constraints[b]={};this.readChildNodes(c,d.constraints[b])},Value:function(b,c){c[this.getChildValue(b)]=true},OutputFormat:function(b,c){c.formats.push({value:this.getChildValue(b)});this.readChildNodes(b,c)},WGS84BoundingBox:function(c,d){var b={};b.crs=c.getAttribute("crs");if(d.BoundingBox){d.BoundingBox.push(b)}else{d.projection=b.crs;b=d}this.readChildNodes(c,b)},BoundingBox:function(b,c){this.readers.ows["WGS84BoundingBox"].apply(this,[b,c])},LowerCorner:function(c,d){var e=this.getChildValue(c).replace(this.regExes.trimSpace,"");e=e.replace(this.regExes.trimComma,",");var b=e.split(this.regExes.splitSpace);d.left=b[0];d.bottom=b[1]},UpperCorner:function(e,f){var g=this.getChildValue(e).replace(this.regExes.trimSpace,"");g=g.replace(this.regExes.trimComma,",");var b=g.split(this.regExes.splitSpace);f.right=b[0];f.top=b[1];var d=a.latLng(f.bottom,f.left);var c=a.latLng(f.top,f.right);f.bounds=a.latLngBounds(d,c);delete f.left;delete f.bottom;delete f.right;delete f.top},Language:function(b,c){c.language=this.getChildValue(b)}}},writers:{ows:{BoundingBox:function(b,d){var c=this.createElementNSPlus(d||"ows:BoundingBox",{attributes:{crs:b.projection}});this.writeNode("ows:LowerCorner",b,c);this.writeNode("ows:UpperCorner",b,c);return c},LowerCorner:function(b){var c=this.createElementNSPlus("ows:LowerCorner",{value:b.bounds.left+" "+b.bounds.bottom});return c},UpperCorner:function(b){var c=this.createElementNSPlus("ows:UpperCorner",{value:b.bounds.right+" "+b.bounds.top});return c},Identifier:function(b){var c=this.createElementNSPlus("ows:Identifier",{value:b});return c},Title:function(c){var b=this.createElementNSPlus("ows:Title",{value:c});return b},Abstract:function(b){var c=this.createElementNSPlus("ows:Abstract",{value:b});return c},OutputFormat:function(c){var b=this.createElementNSPlus("ows:OutputFormat",{value:c});return b}}}});a.Format.OWSCommon.v1_1_0=a.Format.OWSCommon.v1.extend({namespaces:{ows:"http://www.opengis.net/ows/1.1",xlink:"http://www.w3.org/1999/xlink"},readers:{ows:a.FormatUtil.applyDefaults({ExceptionReport:function(b,c){c.exceptionReport={version:b.getAttribute("version"),language:b.getAttribute("xml:lang"),exceptions:[]};this.readChildNodes(b,c.exceptionReport)},AllowedValues:function(b,c){c.allowedValues={};this.readChildNodes(b,c.allowedValues)},AnyValue:function(b,c){c.anyValue=true},DataType:function(b,c){c.dataType=this.getChildValue(b)},Range:function(b,c){c.range={};this.readChildNodes(b,c.range)},MinimumValue:function(c,b){b.minValue=this.getChildValue(c)},MaximumValue:function(c,b){b.maxValue=this.getChildValue(c)},Identifier:function(b,c){c.identifier=this.getChildValue(b)},SupportedCRS:function(b,c){c.supportedCRS=this.getChildValue(b)}},a.Format.OWSCommon.v1.prototype.readers.ows)},writers:{ows:a.FormatUtil.applyDefaults({Range:function(b){var c=this.createElementNSPlus("ows:Range",{attributes:{"ows:rangeClosure":b.closure}});this.writeNode("ows:MinimumValue",b.minValue,c);this.writeNode("ows:MaximumValue",b.maxValue,c);return c},MinimumValue:function(c){var b=this.createElementNSPlus("ows:MinimumValue",{value:c});return b},MaximumValue:function(c){var b=this.createElementNSPlus("ows:MaximumValue",{value:c});return b},Value:function(c){var b=this.createElementNSPlus("ows:Value",{value:c});return b}},a.Format.OWSCommon.v1.prototype.writers.ows)}});a.Format.WMTSCapabilities.v1_0_0=a.Format.OWSCommon.v1_1_0.extend({version:"1.0.0",namespaces:{ows:"http://www.opengis.net/ows/1.1",wmts:"http://www.opengis.net/wmts/1.0",xlink:"http://www.w3.org/1999/xlink"},yx:null,defaultPrefix:"wmts",initialize:function(c){a.Format.XML.prototype.initialize.apply(this,[c]);this.options=c;var b=a.extend({},a.Format.WMTSCapabilities.prototype.yx);this.yx=a.extend(b,this.yx)},read:function(c){if(typeof c=="string"){c=a.Format.XML.prototype.read.apply(this,[c])}if(c&&c.nodeType==9){c=c.documentElement}var b={};this.readNode(c,b);b.version=this.version;return b},readers:{wmts:{Capabilities:function(b,c){this.readChildNodes(b,c)},Contents:function(b,c){c.contents={};c.contents.layers=[];c.contents.tileMatrixSets={};this.readChildNodes(b,c.contents)},Layer:function(c,d){var b={styles:[],formats:[],dimensions:[],tileMatrixSetLinks:[]};b.layers=[];this.readChildNodes(c,b);d.layers.push(b)},Style:function(c,d){var b={};b.isDefault=(c.getAttribute("isDefault")==="true");this.readChildNodes(c,b);d.styles.push(b)},Format:function(b,c){c.formats.push(this.getChildValue(b))},TileMatrixSetLink:function(c,d){var b={};this.readChildNodes(c,b);d.tileMatrixSetLinks.push(b)},TileMatrixSet:function(c,d){if(d.layers){var b={matrixIds:[]};this.readChildNodes(c,b);d.tileMatrixSets[b.identifier]=b}else{d.tileMatrixSet=this.getChildValue(c)}},TileMatrix:function(c,d){var b={supportedCRS:d.supportedCRS};this.readChildNodes(c,b);d.matrixIds.push(b)},ScaleDenominator:function(b,c){c.scaleDenominator=parseFloat(this.getChildValue(b))},TopLeftCorner:function(e,g){var d=this.getChildValue(e);var f=d.split(" ");var b;if(g.supportedCRS){var c=g.supportedCRS.replace(/urn:ogc:def:crs:(\w+):.+:(\w+)$/,"urn:ogc:def:crs:$1::$2");b=!!this.yx[c]}if(b){g.topLeftCorner=a.latLng(f[0],f[1])}else{g.topLeftCorner=a.latLng(f[1],f[0])}},TileWidth:function(b,c){c.tileWidth=parseInt(this.getChildValue(b))},TileHeight:function(b,c){c.tileHeight=parseInt(this.getChildValue(b))},MatrixWidth:function(b,c){c.matrixWidth=parseInt(this.getChildValue(b))},MatrixHeight:function(b,c){c.matrixHeight=parseInt(this.getChildValue(b))},ResourceURL:function(d,e){e.resourceUrl=e.resourceUrl||{};var c=d.getAttribute("resourceType");if(!e.resourceUrls){e.resourceUrls=[]}var b=e.resourceUrl[c]={format:d.getAttribute("format"),template:d.getAttribute("template"),resourceType:c};e.resourceUrls.push(b)},WSDL:function(b,c){c.wsdl={};c.wsdl.href=b.getAttribute("xlink:href")},ServiceMetadataURL:function(b,c){c.serviceMetadataUrl={};c.serviceMetadataUrl.href=b.getAttribute("xlink:href")},LegendURL:function(b,c){c.legend={};c.legend.href=b.getAttribute("xlink:href");c.legend.format=b.getAttribute("format")},Dimension:function(b,d){var c={values:[]};this.readChildNodes(b,c);d.dimensions.push(c)},Default:function(b,c){c["default"]=this.getChildValue(b)},Value:function(b,c){c.values.push(this.getChildValue(b))}},ows:a.Format.OWSCommon.v1_1_0.prototype.readers.ows}});a.Format.WMSCapabilities=a.Format.XML.VersionedOGC.extend({name:"WMSCapabilities",defaultVersion:"1.1.1"});a.Format.WMSCapabilities.v1=a.Format.XML.extend({namespaces:{wms:"http://www.opengis.net/wms",xlink:"http://www.w3.org/1999/xlink",xsi:"http://www.w3.org/2001/XMLSchema-instance"},defaultPrefix:"wms",read:function(d){if(typeof d=="string"){d=a.Format.XML.prototype.read.apply(this,[d])}var c=d;if(d&&d.nodeType==9){d=d.documentElement}var b={};this.readNode(d,b);return b},readers:{wms:{Service:function(b,c){c.service={};this.readChildNodes(b,c.service)},Name:function(b,c){c.name=this.getChildValue(b)},Title:function(b,c){c.title=this.getChildValue(b)},Abstract:function(b,c){c["abstract"]=this.getChildValue(b)},BoundingBox:function(c,d){var e={};e.bbox=[parseFloat(c.getAttribute("minx")),parseFloat(c.getAttribute("miny")),parseFloat(c.getAttribute("maxx")),parseFloat(c.getAttribute("maxy"))];var b={x:parseFloat(c.getAttribute("resx")),y:parseFloat(c.getAttribute("resy"))};if(!(isNaN(b.x)&&isNaN(b.y))){e.res=b}return e},OnlineResource:function(b,c){c.href=this.getAttributeNS(b,this.namespaces.xlink,"href")},ContactInformation:function(b,c){c.contactInformation={};this.readChildNodes(b,c.contactInformation)},ContactPersonPrimary:function(b,c){c.personPrimary={};this.readChildNodes(b,c.personPrimary)},ContactPerson:function(b,c){c.person=this.getChildValue(b)},ContactOrganization:function(b,c){c.organization=this.getChildValue(b)},ContactPosition:function(b,c){c.position=this.getChildValue(b)},ContactAddress:function(b,c){c.contactAddress={};this.readChildNodes(b,c.contactAddress)},AddressType:function(b,c){c.type=this.getChildValue(b)},Address:function(b,c){c.address=this.getChildValue(b)},City:function(b,c){c.city=this.getChildValue(b)},StateOrProvince:function(b,c){c.stateOrProvince=this.getChildValue(b)},PostCode:function(b,c){c.postcode=this.getChildValue(b)},Country:function(b,c){c.country=this.getChildValue(b)},ContactVoiceTelephone:function(b,c){c.phone=this.getChildValue(b)},ContactFacsimileTelephone:function(b,c){c.fax=this.getChildValue(b)},ContactElectronicMailAddress:function(b,c){c.email=this.getChildValue(b)},Fees:function(c,d){var b=this.getChildValue(c);if(b&&b.toLowerCase()!="none"){d.fees=b}},AccessConstraints:function(b,c){var d=this.getChildValue(b);if(d&&d.toLowerCase()!="none"){c.accessConstraints=d}},Capability:function(b,c){c.capability={nestedLayers:[],layers:[]};this.readChildNodes(b,c.capability)},Request:function(b,c){c.request={};this.readChildNodes(b,c.request)},GetCapabilities:function(b,c){c.getcapabilities={formats:[]};this.readChildNodes(b,c.getcapabilities)},Format:function(b,c){if(a.Util.isArray(c.formats)){c.formats.push(this.getChildValue(b))}else{c.format=this.getChildValue(b)}},DCPType:function(b,c){this.readChildNodes(b,c)},HTTP:function(b,c){this.readChildNodes(b,c)},Get:function(b,c){c.get={};this.readChildNodes(b,c.get);if(!c.href){c.href=c.get.href}},Post:function(b,c){c.post={};this.readChildNodes(b,c.post);if(!c.href){c.href=c.get.href}},GetMap:function(b,c){c.getmap={formats:[]};this.readChildNodes(b,c.getmap)},GetFeatureInfo:function(b,c){c.getfeatureinfo={formats:[]};this.readChildNodes(b,c.getfeatureinfo)},Exception:function(b,c){c.exception={formats:[]};this.readChildNodes(b,c.exception)},Layer:function(d,j){var f,c;if(j.capability){c=j.capability;f=j}else{c=j}var r=d.getAttributeNode("queryable");var e=(r&&r.specified)?d.getAttribute("queryable"):null;r=d.getAttributeNode("cascaded");var n=(r&&r.specified)?d.getAttribute("cascaded"):null;r=d.getAttributeNode("opaque");var k=(r&&r.specified)?d.getAttribute("opaque"):null;var p=d.getAttribute("noSubsets");var b=d.getAttribute("fixedWidth");var m=d.getAttribute("fixedHeight");var q=f||{},o=a.Util.extend;var l={nestedLayers:[],styles:f?[].concat(f.styles):[],srs:f?o({},q.srs):{},metadataURLs:[],bbox:f?o({},q.bbox):{},llbbox:q.llbbox,dimensions:f?o({},q.dimensions):{},authorityURLs:f?o({},q.authorityURLs):{},identifiers:{},keywords:[],queryable:(e&&e!=="")?(e==="1"||e==="true"):(q.queryable||false),cascaded:(n!==null)?parseInt(n):(q.cascaded||0),opaque:k?(k==="1"||k==="true"):(q.opaque||false),noSubsets:(p!==null)?(p==="1"||p==="true"):(q.noSubsets||false),fixedWidth:(b!=null)?parseInt(b):(q.fixedWidth||0),fixedHeight:(m!=null)?parseInt(m):(q.fixedHeight||0),minScale:q.minScale,maxScale:q.maxScale,attribution:q.attribution};j.nestedLayers.push(l);l.capability=c;this.readChildNodes(d,l);delete l.capability;if(l.name){var i=l.name.split(":"),h=c.request,g=h.getfeatureinfo;if(i.length>0){l.prefix=i[0]}c.layers.push(l);if(l.formats===undefined){l.formats=h.getmap.formats}if(l.infoFormats===undefined&&g){l.infoFormats=g.formats}}},Attribution:function(b,c){c.attribution={};this.readChildNodes(b,c.attribution)},LogoURL:function(b,c){c.logo={width:b.getAttribute("width"),height:b.getAttribute("height")};this.readChildNodes(b,c.logo)},Style:function(c,d){var b={};d.styles.push(b);this.readChildNodes(c,b)},LegendURL:function(c,d){var b={width:c.getAttribute("width"),height:c.getAttribute("height")};d.legend=b;this.readChildNodes(c,b)},MetadataURL:function(b,c){var d={type:b.getAttribute("type")};c.metadataURLs.push(d);this.readChildNodes(b,d)},DataURL:function(b,c){c.dataURL={};this.readChildNodes(b,c.dataURL)},FeatureListURL:function(b,c){c.featureListURL={};this.readChildNodes(b,c.featureListURL)},AuthorityURL:function(c,e){var b=c.getAttribute("name");var d={};this.readChildNodes(c,d);e.authorityURLs[b]=d.href},Identifier:function(b,d){var c=b.getAttribute("authority");d.identifiers[c]=this.getChildValue(b)},KeywordList:function(b,c){this.readChildNodes(b,c)},SRS:function(b,c){c.srs[this.getChildValue(b)]=true}}}});a.Format.WMSCapabilities.v1_1=a.Format.WMSCapabilities.v1.extend({readers:{wms:a.FormatUtil.applyDefaults({WMT_MS_Capabilities:function(b,c){this.readChildNodes(b,c)},Keyword:function(b,c){if(c.keywords){c.keywords.push(this.getChildValue(b))}},DescribeLayer:function(b,c){c.describelayer={formats:[]};this.readChildNodes(b,c.describelayer)},GetLegendGraphic:function(b,c){c.getlegendgraphic={formats:[]};this.readChildNodes(b,c.getlegendgraphic)},GetStyles:function(b,c){c.getstyles={formats:[]};this.readChildNodes(b,c.getstyles)},PutStyles:function(b,c){c.putstyles={formats:[]};this.readChildNodes(b,c.putstyles)},UserDefinedSymbolization:function(b,c){var d={supportSLD:parseInt(b.getAttribute("SupportSLD"))==1,userLayer:parseInt(b.getAttribute("UserLayer"))==1,userStyle:parseInt(b.getAttribute("UserStyle"))==1,remoteWFS:parseInt(b.getAttribute("RemoteWFS"))==1};c.userSymbols=d},LatLonBoundingBox:function(b,c){c.llbbox=[parseFloat(b.getAttribute("minx")),parseFloat(b.getAttribute("miny")),parseFloat(b.getAttribute("maxx")),parseFloat(b.getAttribute("maxy"))]},BoundingBox:function(b,c){var d=a.Format.WMSCapabilities.v1.prototype.readers.wms.BoundingBox.apply(this,[b,c]);d.srs=b.getAttribute("SRS");c.bbox[d.srs]=d},ScaleHint:function(b,c){},Dimension:function(c,e){var b=c.getAttribute("name").toLowerCase();var d={name:b,units:c.getAttribute("units"),unitsymbol:c.getAttribute("unitSymbol")};e.dimensions[d.name]=d},Extent:function(e,f){var c=e.getAttribute("name").toLowerCase();if(c in f.dimensions){var d=f.dimensions[c];d.nearestVal=e.getAttribute("nearestValue")==="1";d.multipleVal=e.getAttribute("multipleValues")==="1";d.current=e.getAttribute("current")==="1";d["default"]=e.getAttribute("default")||"";var b=this.getChildValue(e);d.values=b.split(",")}}},a.Format.WMSCapabilities.v1.prototype.readers.wms)}});a.Format.WMSCapabilities.v1_1_1=a.Format.WMSCapabilities.v1_1.extend({version:"1.1.1",readers:{wms:a.FormatUtil.applyDefaults({SRS:function(b,c){c.srs[this.getChildValue(b)]=true}},a.Format.WMSCapabilities.v1_1.prototype.readers.wms)}});a.Format.TRouteResultFormat=a.Format.XML.extend({initialize:function(b){a.Format.XML.prototype.initialize.apply(this,[b])},read:function(f){var b=null;if(typeof f=="string"){f=a.Format.XML.prototype.read.apply(this,[f])}if(f&&f.nodeType==9){b={};var c=f.getElementsByTagName("result")[0].childNodes;for(var d=0;d<c.length;d++){var e=c[d];var g=e.nodeName;if(this._resultPaser[g]){this._resultPaser[g](e,b)}}}return b},_resultPaser:{parameters:function(d,e){var b=d.childNodes;e.parameters={};for(var c=0;c<b.length;c++){var d=b[c];if(d.nodeName=="#text"){continue}e.parameters[d.nodeName]=d.text||d.textContent}},routes:function(h,j){var d=h.attributes;var c=h.childNodes;j.routes={};for(var e=0;e<d.length;e++){var g=d[e];if(g.nodeName=="#text"){continue}j.routes[g.nodeName]=g.text||g.textContent}for(var e=0;e<c.length;e++){if(!j.routes.items){j.routes.items=[]}var h=c[e];if(h.nodeName=="#text"){continue}var f={};b(h,f);j.routes.items.push(f)}function b(m,n){var k=m.childNodes;for(var l=0;l<k.length;l++){if(k[l].nodeName=="#text"){continue}n[k[l].nodeName]=k[l].text||k[l].textContent}}},simple:function(f,g){g.simple={};var c=f.childNodes;for(var d=0;d<c.length;d++){if(!g.simple.items){g.simple.items=[]}var f=c[d];if(f.nodeName=="#text"){continue}var e={};b(f,e);g.simple.items.push(e)}function b(k,l){var h=k.childNodes;for(var j=0;j<h.length;j++){if(h[j].nodeName=="#text"){continue}l[h[j].nodeName]=h[j].text||h[j].textContent}}},distance:function(b,c){c.distance=b.text||b.textContent},duration:function(b,c){c.duration=b.text||b.textContent},routelatlon:function(b,c){c.routelatlon=b.text||b.textContent},mapinfo:function(d,e){e.mapinfo={};var b=d.childNodes;for(var c=0;c<b.length;c++){if(b[c].nodeName=="#text"){continue}e.mapinfo[b[c].nodeName]=b[c].text||b[c].textContent}}}});a.TRouteResult=a.Class.extend({data:null,orig:null,dest:null,startFeature:null,endFeature:null,routes:null,segmentFeatures:null,distance:null,duration:null,routelatlon:null,initialize:function(d){if(d){this.data=d;for(var c in d){if(this._resultPaser[c]){var b=a.FormatUtil.bind(this._resultPaser[c],this);b(d[c])}}}},lineStringToGeometry:function(h){var e=[];var f=h.split(";");for(var d=0;d<f.length;d++){if(f[d]==""){continue}var c=f[d].split(",");var b=new a.LatLng(c[1],c[0]);e.push(b)}var g=new a.Polyline(e);return g},_resultPaser:{parameters:function(c){var b=c.orig.split(",");var e=c.dest.split(",");this.start=new a.LatLng(b[1],b[0]);this.end=new a.LatLng(e[1],e[0]);var f=new a.LatLng(this.start.lat,this.start.lng);this.startFeature=new a.Marker(f);var d=new a.LatLng(this.end.lat,this.end.lng);this.endFeature=new a.Marker(d)},routes:function(b){this.routes=b},simple:function(f){this.simple=f;if(!f.items){return}var c=f.items;var e=[];for(var d=0;d<c.length;d++){var b=this.lineStringToGeometry(c[d].streetLatLon);a.setOptions(b,c[d]);e.push(b)}this.simple.segmentFeatures=e},distance:function(b){this.distance=b},duration:function(b){this.duration=b},routelatlon:function(b){this.routelatlon=b},mapinfo:function(b){this.mapinfo=b}}});a.WMTSUtil={getCapabilities:function(b,c,e){var d={SERVICE:"WMTS",VERSION:"1.0.0",REQUEST:"GetCapabilities"};a.get(a.ProxyHost+b,d,function(g){try{var j=g;var i=new a.Format.WMTSCapabilities();var f=i.read(j);if(c){c(f)}}catch(h){if(e){e(h)}}})},getUnitByEpsgCode:function(d){var e={degrees:["4490","4326","4610"],m:["3857","900913","102100"]};var c=d.lastIndexOf(":");d=d.substring(c+1);var b=e.degrees.join(",");if(b.indexOf(d)!=-1){return"degrees"}else{return"m"}},getCapAndUnit:function(b,e){var c=function(n){n.serviceURL=b;var f=n.contents;var k=f.tileMatrixSets;var g=f.layers;var i=g[g.length-1];var h="";var l="";if(i.tileMatrixSetLinks.length>0){var j=i.tileMatrixSetLinks.length;h=i.tileMatrixSetLinks[j-1].tileMatrixSet;l=k[h].supportedCRS}var m=a.WMTSUtil.getUnitByEpsgCode(l);e(n,m)};var d=function(){};this.getCapabilities(b,c,d)},getLayer:function(c){try{var d=c.serviceURL;var t=c.contents;var m=t.tileMatrixSets;var h=t.layers;var o=null;var l=null;for(var q=h.length-1;q>=0;q--){var w="Default";if(h[q].styles.length>0){w=h[q].styles[0].identifier}var f=h[q].formats[0];var b="";if(h[q].tileMatrixSetLinks.length>0){var r=h[q].tileMatrixSetLinks.length;b=h[q].tileMatrixSetLinks[r-1].tileMatrixSet}var i=t.tileMatrixSets[b].matrixIds;var s=i[0].topLeftCorner;var n=[];for(var p=0;p<i.length;p++){n.push({identifier:i[p].identifier,scaleDenominator:i[p].scaleDenominator,topLeftCorner:s})}var g=c.contents.layers[0].bounds;var v=new a.TileLayer.WMTS(d,{tileSize:256,layer:h[q].identifier,style:w,tilematrixSet:b,format:f,matrixIds:n,fullExtent:g});return v}}catch(u){throw u}}};a.Geocoder=a.Class.extend({options:{url:null},initialize:function(b){a.setOptions(this,b)},getLatLngInfo:function(b,c){this._getLatLngInfo(b,c)},getLocation:function(c,b){this._getLocation(c,b)},_getLatLngInfo:function(f,g){var c=this.options.url;if(!c){return false}var b=f.address;var e=f.city;var d=f.format||"json";c=c+"?format="+d+"&address="+b;if(e){c=c+"&city="+e}if(d=="json"){a.jsonp(c,null,function(h){if(g&&typeof(g)=="function"){g(h)}})}else{a.get(c,null,function(h){if(g&&typeof(g)=="function"){g(h)}})}},_getLocation:function(d,c){var b=this.options.url;if(!b){return false}b=b+"?format=json&lon="+d.lng+"&lat="+d.lat;a.jsonp(b,null,function(e){if(c&&typeof(c)=="function"){c(e)}})}});a.TGeocoder=a.Class.extend({options:{url:"http://www.tianditu.com/query.shtml"},initialize:function(b){a.setOptions(this,b)},getLocation:function(c,b){this._getLocation(c,b)},_getLocation:function(c,k){var b=this.options.url;if(!b){return false}var j={};j.lon=c.lng;j.lat=c.lat;j.appkey="8a7b9aac0db21f9dd995e61a14685f05";j.ver=1;var h=["lon","lat","appkey","ver"];var e="?postStr=";var d=[];for(var f=0;f<h.length;f++){var l=h[f];if(l in j){d.push("'"+l+"':'"+j[l]+"'")}}e+="{"+d.join(",")+"}";e+="&type=geocode";var g=this;a.get(a.ProxyHost+b+e,null,function(i){try{var m=JSON.parse(i);if(k&&typeof(k)=="function"){k(m)}}catch(n){if(k&&typeof(k)=="function"){k(i)}}})}});a.Geolocation=a.Class.extend({options:{enableHighAccuracy:false,timeout:5000,maximumAge:3000},initialize:function(b){a.setOptions(this,b)},getCurrentPosition:function(g,c){a.setOptions(this,c);if(navigator.geolocation){var f=function(i){var j=i.coords;var k=new a.LatLng(j.latitude,j.longitude);var h={latlng:k,status:"ok"};g(h)};var e=function(i){var j="";switch(i.code){case i.PERMISSION_DENIED:j="User denied the request for Geolocation.";break;case i.POSITION_UNAVAILABLE:j="Location information is unavailable.";break;case i.TIMEOUT:j="The request to get user location timed out.";break;case i.UNKNOWN_ERROR:j="An unknown error occurred.";break}var h={latlng:null,status:"error",errorMsg:j};g(h)};navigator.geolocation.getCurrentPosition(f,e,this.options)}else{var d="Your browser does not support Geolocation!";var b={latlng:null,status:"error",errorMsg:d};g(b)}}});a.LocalSearch=a.Class.extend({options:{url:null,pageNum:0,pageSize:10,onSearchComplete:null,param:null,resultType:0,currentResult:null},initialize:function(c,b){this.map=c;a.setOptions(this,b)},setUrl:function(b){this.options.url=b},setPageSize:function(b){this.options.pageSize=b},getPageSize:function(){return this.options.pageSize},setSearchCompleteCallback:function(b){this.options.onSearchComplete=b},search:function(b,c){switch(c){case 1:this.options.resultType=1;this._search(b,null);break;case 2:this.options.resultType=2;this._searchInView(b,null);break;case 3:this.options.resultType=3;this._searchStatistics(b,null);break}},searchBySort:function(b,c){switch(c){case 1:this.options.resultType=4;this._search(null,b);break;case 2:this.options.resultType=5;this._searchInView(null,b);break;case 3:this.options.resultType=6;this._searchStatistics(null,b);break}},searchInBounds:function(c,e){this.options.resultType=7;if(e instanceof a.LatLngBounds){e=[e.getSouth(),e.getWest(),e.getNorth(),e.getEast()].join(",")}var f=this.options.pageNum;var b=this.options.pageSize;var g={keyword:c,bounds:e,pageNum:f,pageSize:b};this.options.param=g;var d=this._queryParam(g);if(d){this._doQuery(d)}},searchInBoundsBySort:function(d,e){this.options.resultType=8;if(e instanceof a.LatLngBounds){e=[e.getSouth(),e.getWest(),e.getNorth(),e.getEast()].join(",")}var f=this.options.pageNum;var b=this.options.pageSize;var g={sort:d,bounds:e,pageNum:f,pageSize:b};this.options.param=g;var c=this._queryParam(g);if(c){this._doQuery(c)}},searchNearby:function(e,c,b){this.options.resultType=9;var g=this.options.pageNum;var d=this.options.pageSize;var h={keyword:e,center:c,radius:b,pageNum:g,pageSize:d};this.options.param=h;var f=this._queryBufferParam(h);if(f){this._doQuery(f)}},searchNearbyBySort:function(f,c,b){this.options.resultType=10;var g=this.options.pageNum;var d=this.options.pageSize;var h={sort:f,center:c,radius:b,pageNum:g,pageSize:d};this.options.param=h;var e=this._queryBufferParam(h);if(e){this._doQuery(e)}},getResults:function(){return this.options.currentResult},clearResults:function(){this.options.currentResult=null;this.options.pageNum=0},getTotalPage:function(){var d;var b=this.options.currentResult;if(b){var c=b.totalCount;if(c&&c>0){d=Math.ceil(c/this.options.pageSize)-1}}return d},firstPage:function(){this.gotoPage(0)},nextPage:function(){var c=this.options.param;var b=c.pageNum;this.gotoPage(b+1)},previousPage:function(){var c=this.options.param;var b=c.pageNum;this.gotoPage(b-1)},lastPage:function(){var c=this.options.param;var b=this.getTotalPage();this.gotoPage(b)},gotoPage:function(c){var d=this.options.param;var b=this.getTotalPage();if(d&&b){if(c>b){c=b}else{if(c<0){c=0}}d.pageNum=c;if(d.radius){url=this._queryBufferParam(d)}else{url=this._queryParam(d)}if(url){this._doQuery(url)}}},searchNear:function(d){this.options.resultType=11;var b=this.options.url;if(!b){return false}b=b+"/nearest?location="+d.lat+","+d.lng;var c=this;a.jsonp(b,null,function(e){if(c.options.onSearchComplete){c.options.onSearchComplete.call(c,e,c.options.resultType)}})},_doQuery:function(b){var c=this;a.jsonp(b,null,function(d){c.options.currentResult=d;if(c.options.onSearchComplete){c.options.onSearchComplete.call(c,d,c.options.resultType)}})},_search:function(c,e){var f=this.options.pageNum;var b=this.options.pageSize;var g={keyword:c,sort:e,pageNum:f,pageSize:b};this.options.param=g;var d=this._queryParam(g);if(d){this._doQuery(d)}},_searchInView:function(c,e){var f=this.map.getBounds();var i=[f.getSouth(),f.getWest(),f.getNorth(),f.getEast()].join(",");var g=this.options.pageNum;var b=this.options.pageSize;var h={keyword:c,sort:e,bounds:i,pageNum:g,pageSize:b};this.options.param=h;var d=this._queryParam(h);if(d){this._doQuery(d)}},_searchStatistics:function(b,d){var e={keyword:b,sort:d};var c=this._queryStatParam(e);if(c){this._doQuery(c)}},_queryParam:function(i){var d=this.options.url;if(!d){return false}var c=i.keyword;var e=i.sort;var f=i.bounds;var h=i.city;var g=i.pageNum;var b=i.pageSize;d=d+"/search?format=json&page_num="+g+"&page_size="+b;if(c){d+="&q="+encodeURIComponent(c)}if(e){d+="&type="+encodeURIComponent(e)}if(h){d+="&city="+encodeURIComponent(h)}if(f){d+="&sq_type=bounds&bounds="+encodeURIComponent(f)}return d},_queryBufferParam:function(d,h,j){var c=this.options.url;if(!c){return false}var e=d.keyword;var i=d.sort;var f=d.radius;var b=option.center;c=c+"/search?format=json";if(e){c+="&q="+encodeURIComponent(e)}if(i){c+="&type="+encodeURIComponent(i)}var h=d.pageNum;var j=d.pageSize;var g="&page_num={page_num}&page_size={page_size}&sq_type=buffer&location={y},{x}&radius={r}".replace("{page_num}",h).replace("{page_size}",j).replace("{x}",b.lng).replace("{y}",b.lat).replace("{r}",f);c+=g;return c},_queryStatParam:function(e){var c=this.options.url;if(!c){return false}var b=e.keyword;var d=e.sort;c=c+"/statistic?";if(b){c+="&q="+encodeURIComponent(b)}if(d){c+="&type="+encodeURIComponent(d)}return c}});a.TLocalSearch=a.Class.extend({options:{url:"http://www.tianditu.com/query.shtml",pageNum:0,pageSize:10,onSearchComplete:null,param:null,resultType:0,currentResult:null},initialize:function(c,b){this.map=c;a.setOptions(this,b)},setUrl:function(b){this.options.url=b},setPageSize:function(b){this.options.pageSize=b},getPageSize:function(){return this.options.pageSize},setSearchCompleteCallback:function(b){this.options.onSearchComplete=b},search:function(b,c){this._search(b,c)},searchInBounds:function(b,c){param.mapBound=c.toBBoxString();this._search(b,10)},searchNearby:function(e,c,b){var f=this.options.pageNum;var d=this.options.pageSize;var g={keyWord:encodeURIComponent(e),pageNum:f,pageSize:d,queryType:3,queryRadius:b,pointLonlat:c.lng+","+c.lat};this.options.param=g;this._dosearch()},getResults:function(){return this.options.currentResult},clearResults:function(){this.options.currentResult=null;this.options.pageNum=0},getTotalPage:function(){var d;var b=this.options.currentResult;if(b){var c=b.count;if(c&&c>0){d=Math.ceil(c/this.options.pageSize)-1}}return d},firstPage:function(){this.gotoPage(0)},nextPage:function(){var c=this.options.param;var b=c.pageNum;this.gotoPage(b+1)},previousPage:function(){var c=this.options.param;var b=c.pageNum;this.gotoPage(b-1)},lastPage:function(){var c=this.options.param;var b=this.getTotalPage();this.gotoPage(b)},gotoPage:function(c){var d=this.options.param;var b=this.getTotalPage();if(d&&b){if(c>b){c=b}else{if(c<0){c=0}}d.pageNum=c;this._dosearch()}},_search:function(d,b){var e=this.options.pageNum;var c=this.options.pageSize;var f={keyWord:encodeURIComponent(d),pageNum:e,pageSize:c,queryType:b};this.options.param=f;this._dosearch()},_dosearch:function(){var d=this.options.param;var b=this._queryParam(d);if(b){var c=this;a.get(a.ProxyHost+b,null,function(f){try{var g=JSON.parse(f);c.options.currentResult=g;if(c.options.onSearchComplete){c.options.onSearchComplete.call(c,g,c.options.queryType)}}catch(h){if(c.options.onSearchComplete){c.options.onSearchComplete.call(c,f,c.options.queryType)}}})}},_queryParam:function(e){var c=this.options.url;if(!c){return false}var m=a.setOptions({},e);var j=e.pageSize;var d=e.pageNum*e.pageSize;if(this.map){var b=this.map.getZoom();m.level=m.level||b;var l=this.map.getBounds().toBBoxString();m.mapBound=m.mapBound||l}m.queryType=m.queryType||1;m.count=j||10;m.start=d||0;var k=["keyWord","level","mapBound","pointLonlat","queryRadius","queryType","specifyAdminCode","count","start"];var h="?postStr=";var f=[];for(var g=0;g<k.length;g++){var n=k[g];if(n in m){f.push("'"+n+"':'"+m[n]+"'")}}h+="{"+f.join(",")+"}";h+="&type=query";c=c+encodeURIComponent(h);return c}});a.RoutePlan=a.Class.extend({options:{plan:null},initialize:function(b){a.setOptions(this,b)},getDistance:function(){var b=this.options.plan;if(b){return parseInt(b.distance/1000)+"公里"}return null},getDuration:function(){var b=this.options.plan;if(b){return this._formatMinute(route.duration)}return null},getNumSteps:function(){var b=this.options.plan;if(b){return b.steps.length}return null},getStep:function(c){var d=this.options.plan;if(d){var b=d.steps;return b[c]}return null},_formatMinute:function(e){var d=parseInt(e);var c=0;if(d>60){c=parseInt(d/60);d=parseInt(d%60)}var b=0;if(c>0){b=""+parseInt(c)+"小时"}b=b+d+"分钟";return b}});a.DrivingRoute=a.Class.extend({options:{url:null,policy:0,onSearchComplete:null,start:null,end:null,waypoints:[],currentResult:null,},initialize:function(c,b){this.map=c;a.setOptions(this,b)},setPolicy:function(c,b){this.options.policy=c;if(!b){this._search()}},search:function(c,b){if(c instanceof a.LatLng&&b instanceof a.LatLng){this.options.start=c;this.options.end=b;this._search()}else{this._failFn()}},setWayPoints:function(c,b){if(c&&c.length>0){this.options.waypoints=c;if(!b){this._search()}}},getWayPoints:function(){return this.options.waypoints},clearResults:function(){this.options.policy=0;this.options.start=null;this.options.end=null;this.options.currentResult=null},getResults:function(){return this.options.currentResult},getStart:function(){return this.options.start},getEnd:function(){return this.options.end},getNumPlans:function(){var b=this.options.currentResult;if(b&&b.status.toLowerCase()=="ok"){return b.totalCount}else{return 0}},getPlan:function(b){var c=this.getNumPlans();var d;if(c>0){var e=this.options.currentResult.results;if(typeof b==="number"&&isFinite(b)&&b<=c){d=e[b];return new a.RoutePlan({plan:d})}}return false},_failFn:function(){var b={msg:"起始点参数不正确，请传入L.LatLng类型参数",status:"error"};if(this.options.onSearchComplete){this.options.onSearchComplete.call(this,b)}},_search:function(){var b=this._queryParam();if(b){var c=this;a.jsonp(b,null,function(d){c.options.currentResult=d;if(c.options.onSearchComplete){c.options.onSearchComplete.call(c,d)}})}},_queryParam:function(){var b=this.options.url;var c=this.options.start;var d=this.options.end;var h=this.options.policy;if(c&&d&&b){var l=c.lng+","+c.lat;var k=d.lng+","+d.lat;b=b+"?format=json&origin="+l+"&destination="+k+"&mode="+h;var j=this.getWayPoints();if(j&&j.length>0){var g=[];for(var f=0;f<j.length;f++){var e=j[f].lng+","+j[f].lat;g.push(e)}b+="&waypoints="+g.join(";")}return b}else{return false}}});a.TDrivingRoute=a.Class.extend({options:{url:"http://www.tianditu.com/query.shtml",policy:0,onSearchComplete:null,start:null,end:null,waypoints:[],currentResult:null,},initialize:function(c,b){this.map=c;a.setOptions(this,b)},setPolicy:function(c,b){this.options.policy=c;if(!b){this._search()}},search:function(c,b){if(c instanceof a.LatLng&&b instanceof a.LatLng){this.options.start=c;this.options.end=b;this._search()}else{this._failFn()}},setWayPoints:function(c,b){if(c&&c.length>0){this.options.waypoints=c;if(!b){this._search()}}},getWayPoints:function(){return this.options.waypoints},clearResults:function(){this.options.policy=0;this.options.start=null;this.options.end=null;this.options.currentResult=null},getResults:function(){return this.options.currentResult},getStart:function(){return this.options.start},getEnd:function(){return this.options.end},_failFn:function(){var b={msg:"起始点参数不正确，请传入L.LatLng类型参数",status:"error"};if(this.options.onSearchComplete){this.options.onSearchComplete.call(this,b)}},_search:function(){var b=this._queryParam();if(b){var c=this;a.get(b,null,function(d){try{var h=new a.Format.TRouteResultFormat();var f=new a.TRouteResult(h.read(d));c.options.currentResult=f;if(c.options.onSearchComplete){c.options.onSearchComplete.call(c,f)}}catch(g){if(c.options.onSearchComplete){c.options.onSearchComplete.call(c,d)}}})}},_queryParam:function(){var b=this.options.url;var c=this.options.start;var d=this.options.end;var l=this.options.policy;if(c&&d&&b){var m=this.getWayPoints();var q="";if(m&&m.length>0){var k=[];for(var h=0;h<m.length;h++){var f=m[h].lng+","+m[h].lat;k.push(f)}q=k.join(";")}var p=c.lng+","+c.lat;var n=d.lng+","+d.lat;var o={};o.orig=p;o.dest=n;o.style=l;o.mid=q;var j=["orig","dest","style","mid"];var g="?postStr=";var e=[];for(var h=0;h<j.length;h++){var r=j[h];if(r in o){e.push("'"+r+"':'"+o[r]+"'")}}g+="{"+e.join(",")+"}";g+="&type=search";b=b+g;return b}else{return false}}});a.ImeMapService=a.Class.extend({options:{url:null},initialize:function(b){a.setOptions(this,b)},getLayerLegend:function(b,h,j){var d=this.options.url+"/"+b+"/legend?";var g=["width","height","format"];var c=0;for(var e=0;e<g.length;e++){var f=g[e];if(f in h){if(c==0){d+=f+"="+h[f]}else{d+="&"+f+"="+h[f]}c++}}a.jsonp(d,null,function(i){if(j&&typeof j=="function"){j(i)}})},querySingleLayer:function(b,h,j){var d=this.options.url+"/"+b+"/query?";var g=["spatialOper","geometry","where","orderBy","outFields","format"];var c=0;for(var e=0;e<g.length;e++){var f=g[e];if(f in h){if(f=="geometry"){h[f]=a.Util.writeGeometryToWKT(h[f],"polygon")}if(c==0){d+=f+"="+h[f]}else{d+="&"+f+"="+h[f]}c++}}a.jsonp(d,null,function(i){if(j&&typeof j=="function"){j(i)}})},identify:function(g,f,h){var b={};b.xmin=g.xmin;b.ymin=g.ymin;b.xmax=g.xmax;b.ymax=g.ymax;b.width=g.width;b.height=g.height;if(g.layers){b.layers=g.layers}a.extend(b,f);var d=this.options.url+"/identify";var e=a.Util.getParamString(b);var c=d+"?"+e;a.jsonp(c,null,function(i){if(h&&typeof h=="function"){h(i)}})}});return a}));